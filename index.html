<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£ Observer</title>
<style>
:root {
  --bg:#f5f7fa;--surface:#fff;--surface2:#f0f2f5;--text:#2d3436;--text-muted:#888;
  --border:#e1e5ea;--shadow:0 2px 12px rgba(0,0,0,.06);--radius:14px;
  --accent:#5b6abf;--accent-bg:#eef0ff;
  --danger:#e74c3c;--danger-bg:#fdf0ef;
  --success:#27ae60;--success-bg:#e8f8ef;
  --dark:#7c3aed;--dark-bg:#f3eeff;
  --type:#0891b2;--type-bg:#ecfeff;
  --entre:#d97706;--entre-bg:#fffbeb;
  --capital:#059669;--capital-bg:#ecfdf5;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans','Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);line-height:1.7;min-height:100vh;-webkit-text-size-adjust:100%}
.container{max-width:640px;margin:0 auto;padding:12px;padding-bottom:100px}
.app-header{text-align:center;padding:20px 0 12px}
.app-header h1{font-size:1.3em;font-weight:800;color:var(--accent)}
.app-header .sub{color:var(--text-muted);font-size:.78em;margin-top:2px}

/* Tabs */
.tabs{display:flex;background:var(--surface);border-radius:12px;padding:3px;margin-bottom:16px;box-shadow:var(--shadow);gap:2px}
.tab{flex:1;text-align:center;padding:9px 4px;border-radius:10px;font-size:.8em;font-weight:600;cursor:pointer;transition:.2s;color:var(--text-muted);position:relative;-webkit-tap-highlight-color:transparent}
.tab.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(91,106,191,.3)}
.tab .badge{position:absolute;top:2px;right:4px;background:var(--danger);color:#fff;font-size:.6em;padding:1px 5px;border-radius:10px;font-weight:700}

.view{display:none}.view.active{display:block}

/* Shared card */
.card{background:var(--surface);border-radius:var(--radius);padding:18px;margin-bottom:12px;box-shadow:var(--shadow)}

/* Module selection */
.module-grid{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
.module-card{display:flex;align-items:center;gap:14px;padding:16px;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);cursor:pointer;border:2px solid transparent;transition:.15s;-webkit-tap-highlight-color:transparent}
.module-card.selected{border-color:var(--accent);background:var(--accent-bg)}
.module-card:active{transform:scale(.98)}
.module-check{width:24px;height:24px;border-radius:7px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.8em;transition:.15s}
.module-card.selected .module-check{background:var(--accent);border-color:var(--accent);color:#fff}
.module-info{flex:1}
.module-info .name{font-weight:700;font-size:.92em}
.module-info .desc{font-size:.72em;color:var(--text-muted)}
.module-info .count{font-size:.68em;font-weight:600;margin-top:2px}

/* Name input */
.name-wrap{text-align:center;margin-bottom:14px}
.name-wrap label{display:block;font-size:.82em;color:var(--text-muted);margin-bottom:6px}
.name-wrap input{border:2px solid var(--border);padding:11px 16px;border-radius:10px;font-size:1em;text-align:center;width:100%;max-width:260px;outline:none;transition:.2s;background:var(--surface2)}
.name-wrap input:focus{border-color:var(--accent)}

/* Progress */
.progress-wrap{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.progress-bar{flex:1;background:var(--border);border-radius:10px;height:7px;overflow:hidden}
.progress-fill{height:100%;border-radius:10px;transition:width .4s ease}
.progress-text{font-size:.75em;font-weight:700;white-space:nowrap}

/* Section header in questionnaire */
.section-header{padding:10px 16px;border-radius:10px;margin-bottom:10px;font-weight:700;font-size:.85em;color:#fff}

/* Question card */
.q-card{background:var(--surface);border-radius:var(--radius);padding:18px;margin-bottom:10px;box-shadow:var(--shadow);border-left:4px solid var(--accent)}
.q-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.q-num{font-size:.72em;font-weight:700}
.q-tag{font-size:.62em;padding:2px 7px;border-radius:6px;font-weight:600}
.q-text{font-size:.95em;margin-bottom:4px;font-weight:600}
.q-hint{font-size:.74em;color:var(--text-muted);margin-bottom:12px}

/* Likert */
.likert{display:flex;gap:5px}
.likert label{flex:1;text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
.likert input{display:none}
.likert .chip{display:flex;flex-direction:column;align-items:center;padding:9px 2px;border-radius:10px;background:var(--surface2);border:2px solid transparent;transition:.15s;font-size:.95em;font-weight:700;color:var(--text-muted)}
.likert .chip-label{font-size:.5em;font-weight:500;margin-top:2px;line-height:1.2;color:inherit}
.likert label:active .chip{transform:scale(.95)}
.likert input:checked+.chip{color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}

/* Nav */
.nav-buttons{display:flex;gap:10px;margin:16px 0;position:sticky;bottom:12px;z-index:10}
.nav-btn{flex:1;padding:13px;border-radius:12px;border:none;font-size:.95em;font-weight:700;cursor:pointer;transition:.15s;-webkit-tap-highlight-color:transparent}
.nav-btn:disabled{opacity:.3;cursor:not-allowed}
.nav-btn:active:not(:disabled){transform:scale(.97)}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 4px 12px rgba(91,106,191,.3)}
.btn-secondary{background:var(--surface);color:var(--text);border:2px solid var(--border)}
.btn-save{background:var(--success-bg);color:var(--success);border:1px solid var(--success)}
.btn-ai{background:var(--dark-bg);color:var(--dark);border:1px solid var(--dark)}

/* Results */
.result-header{text-align:center;margin-bottom:20px}
.result-header h2{font-size:1.15em;font-weight:800;color:var(--accent)}
.result-header .date{font-size:.78em;color:var(--text-muted)}

.section-title{font-size:1em;font-weight:800;padding:12px 0 8px;border-bottom:2px solid var(--border);margin:20px 0 12px;display:flex;align-items:center;gap:8px}
.section-title .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

.trait-card{background:var(--surface);border-radius:var(--radius);padding:18px;margin-bottom:12px;box-shadow:var(--shadow)}
.trait-title-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.trait-name{font-size:.9em;font-weight:700}
.trait-badge{font-size:1em;font-weight:800;padding:2px 10px;border-radius:8px}

.bar-row{display:flex;align-items:center;margin-bottom:5px;gap:6px}
.bar-label{width:72px;font-size:.72em;font-weight:600;text-align:right;flex-shrink:0}
.bar-track{flex:1;height:20px;background:var(--surface2);border-radius:10px;overflow:hidden}
.bar-fill{height:100%;border-radius:10px;transition:width .8s;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:.65em;font-weight:700;color:#fff;min-width:32px}
.bar-value{width:38px;font-size:.75em;font-weight:700;flex-shrink:0;text-align:right}

.spectrum{display:flex;align-items:center;gap:5px;margin:8px 0}
.spectrum-label{font-size:.6em;font-weight:600;width:58px;text-align:center;flex-shrink:0;line-height:1.3}
.spectrum-track{flex:1;height:7px;border-radius:4px;position:relative}
.spectrum-marker{position:absolute;top:-7px;width:20px;height:20px;border:3px solid #fff;border-radius:50%;transform:translateX(-50%);box-shadow:0 2px 6px rgba(0,0,0,.2);transition:left .8s}

.facets-info{margin-top:6px;font-size:.7em;color:var(--text-muted);line-height:1.6}
.calc-toggle{display:inline-block;font-size:.75em;color:var(--accent);cursor:pointer;font-weight:600;margin-top:6px;padding:3px 0;-webkit-tap-highlight-color:transparent}
.calc-detail{display:none;background:var(--surface2);border-radius:10px;padding:12px;margin-top:6px;font-size:.78em}
.calc-detail.show{display:block}
.calc-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);gap:6px}
.calc-row:last-child{border-bottom:none}
.calc-row .calc-formula{flex-shrink:0;color:var(--text-muted);font-size:.88em;text-align:right}
.calc-row.reverse .calc-formula{color:var(--danger)}
.calc-row.total{font-weight:700;border-top:2px solid var(--border);margin-top:4px;padding-top:6px}

/* 4 Types highlight */
.type-highlight{text-align:center;padding:20px;border-radius:var(--radius);margin-bottom:14px}
.type-highlight .label{font-size:.8em;font-weight:600;margin-bottom:4px}
.type-highlight .primary{font-size:1.4em;font-weight:800}
.type-highlight .sub{font-size:.78em;margin-top:4px}

/* Dark Triad interpretations */
.interp{display:flex;gap:10px;margin-top:8px;font-size:.75em}
.interp .biz{flex:1;padding:8px;border-radius:8px;background:var(--success-bg);color:#1e7a44}
.interp .shadow{flex:1;padding:8px;border-radius:8px;background:var(--danger-bg);color:#c0392b}
.interp b{display:block;margin-bottom:2px;font-size:.9em}

/* Radar */
.radar-section{text-align:center;background:var(--surface);border-radius:var(--radius);padding:16px 8px;margin-bottom:12px;box-shadow:var(--shadow)}
.radar-section h3{font-size:.88em;margin-bottom:8px;color:var(--text-muted)}
canvas{max-width:100%;height:auto}
.legend{display:flex;justify-content:center;gap:16px;margin-top:6px;font-size:.72em}
.legend-dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:3px}

/* Summary */
.summary-card{background:var(--surface);border-radius:var(--radius);padding:18px;margin:12px 0;box-shadow:var(--shadow)}
.summary-card h3{font-size:.9em;margin-bottom:10px}
.summary-text{font-size:.85em;line-height:1.9}

.result-actions{display:flex;gap:8px;margin:16px 0;flex-wrap:wrap}
.result-actions .nav-btn{font-size:.85em;padding:11px}

/* List */
.list-empty{text-align:center;padding:50px 20px;color:var(--text-muted)}
.list-empty p{font-size:.88em}
.saved-card{background:var(--surface);border-radius:var(--radius);padding:14px;margin-bottom:10px;box-shadow:var(--shadow);cursor:pointer;transition:.15s;-webkit-tap-highlight-color:transparent}
.saved-card:active{transform:scale(.98)}
.saved-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.saved-card-name{font-weight:700;font-size:.95em}
.saved-card-date{font-size:.72em;color:var(--text-muted)}
.saved-card-scores{display:flex;gap:4px;flex-wrap:wrap}
.mini-score{font-size:.65em;font-weight:700;padding:2px 6px;border-radius:5px}
.saved-card-actions{display:flex;gap:6px;margin-top:8px;justify-content:flex-end}
.small-btn{font-size:.72em;padding:4px 10px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;font-weight:600;-webkit-tap-highlight-color:transparent}
.small-btn.delete{color:var(--danger);border-color:var(--danger);background:var(--danger-bg)}

.detail-back{display:inline-flex;align-items:center;gap:4px;font-size:.82em;color:var(--accent);font-weight:600;cursor:pointer;margin-bottom:14px;-webkit-tap-highlight-color:transparent}

/* AI Analysis */
.api-key-section{margin-bottom:14px}
.api-key-section label{font-size:.82em;font-weight:600;display:block;margin-bottom:6px}
.api-key-row{display:flex;gap:8px}
.api-key-row input{flex:1;padding:10px 12px;border:2px solid var(--border);border-radius:10px;font-size:.88em;outline:none;background:var(--surface2)}
.api-key-row input:focus{border-color:var(--dark)}
.api-key-row button{padding:10px 16px;border-radius:10px;border:none;background:var(--dark);color:#fff;font-weight:700;font-size:.82em;cursor:pointer}
.model-select{margin-top:8px;font-size:.8em}
.model-select select{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);font-size:1em}
.ai-textarea{width:100%;min-height:120px;padding:14px;border:2px solid var(--border);border-radius:var(--radius);font-size:.92em;line-height:1.6;resize:vertical;outline:none;font-family:inherit;background:var(--surface)}
.ai-textarea:focus{border-color:var(--dark)}
.ai-context-toggle{display:flex;align-items:center;gap:8px;font-size:.82em;margin:10px 0;cursor:pointer;-webkit-tap-highlight-color:transparent}
.ai-context-toggle input{width:18px;height:18px;accent-color:var(--dark)}
.ai-prompts{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
.ai-prompt-chip{font-size:.72em;padding:5px 10px;border-radius:8px;background:var(--dark-bg);color:var(--dark);border:1px solid transparent;cursor:pointer;font-weight:600;-webkit-tap-highlight-color:transparent;transition:.15s}
.ai-prompt-chip:hover,.ai-prompt-chip:active{border-color:var(--dark)}
.ai-result{background:var(--surface);border-radius:var(--radius);padding:18px;margin-top:14px;box-shadow:var(--shadow);font-size:.88em;line-height:1.9;white-space:pre-wrap}
.ai-loading{text-align:center;padding:30px;color:var(--dark);font-weight:600}

/* Person group */
.person-group{margin-bottom:18px}
.person-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--accent);color:#fff;border-radius:var(--radius) var(--radius) 0 0;cursor:pointer;-webkit-tap-highlight-color:transparent}
.person-header .name{font-weight:700;font-size:.95em}
.person-header .count{font-size:.72em;opacity:.8}
.person-entries{background:var(--surface);border-radius:0 0 var(--radius) var(--radius);box-shadow:var(--shadow);overflow:hidden}
.person-entry{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:.1s;-webkit-tap-highlight-color:transparent}
.person-entry:last-child{border-bottom:none}
.person-entry:active{background:var(--surface2)}
.person-entry .date{font-size:.78em;color:var(--text-muted);font-weight:600}
.person-entry .scores{display:flex;gap:3px;flex-wrap:wrap;flex:1;margin:0 10px}
.person-entry .del-btn{font-size:.68em;color:var(--danger);cursor:pointer;padding:3px 8px;border-radius:6px;border:1px solid var(--danger);background:var(--danger-bg);flex-shrink:0}
.timeline-btn{display:block;width:100%;padding:10px;text-align:center;font-size:.82em;font-weight:700;color:var(--accent);background:var(--accent-bg);border:none;cursor:pointer;border-radius:0 0 var(--radius) var(--radius);-webkit-tap-highlight-color:transparent}
.timeline-btn:active{opacity:.7}

/* Timeline chart */
.timeline-section{background:var(--surface);border-radius:var(--radius);padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
.timeline-section h3{font-size:.9em;margin-bottom:4px;font-weight:700}
.timeline-section .sub{font-size:.72em;color:var(--text-muted);margin-bottom:10px}
.timeline-legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;font-size:.68em}
.timeline-legend span{display:flex;align-items:center;gap:3px}
.timeline-legend .dot{width:8px;height:8px;border-radius:50%}
.change-indicator{font-size:.72em;font-weight:700;padding:2px 6px;border-radius:5px;margin-left:4px}
.change-up{color:#16a34a;background:#f0fdf4}
.change-down{color:#dc2626;background:#fef2f2}
.change-flat{color:var(--text-muted);background:var(--surface2)}

/* Export/Import */
.data-actions{display:flex;gap:8px;margin:14px 0;flex-wrap:wrap}
.data-actions button{flex:1;padding:10px;border-radius:10px;font-size:.82em;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);-webkit-tap-highlight-color:transparent;min-width:120px}
.data-actions button:active{transform:scale(.97)}
.data-actions .export-btn{color:var(--accent);border-color:var(--accent);background:var(--accent-bg)}
.data-actions .import-btn{color:var(--success);border-color:var(--success);background:var(--success-bg)}

/* Google Drive sync */
.drive-section{background:var(--surface);border-radius:var(--radius);padding:16px;margin-bottom:14px;box-shadow:var(--shadow);border:2px solid var(--border)}
.drive-section.connected{border-color:var(--success)}
.drive-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.drive-header .icon{font-size:1.2em}
.drive-header .title{font-weight:700;font-size:.88em;flex:1}
.drive-header .status{font-size:.68em;font-weight:600;padding:3px 8px;border-radius:6px}
.drive-header .status.on{color:var(--success);background:var(--success-bg)}
.drive-header .status.off{color:var(--text-muted);background:var(--surface2)}
.drive-body{display:none}
.drive-body.open{display:block}
.drive-url-row{display:flex;gap:8px;margin-bottom:8px}
.drive-url-row input{flex:1;padding:9px 12px;border:2px solid var(--border);border-radius:10px;font-size:.8em;outline:none;background:var(--surface2)}
.drive-url-row input:focus{border-color:var(--success)}
.drive-url-row button{padding:9px 14px;border-radius:10px;border:none;background:var(--success);color:#fff;font-weight:700;font-size:.78em;cursor:pointer;white-space:nowrap}
.drive-help{font-size:.68em;color:var(--text-muted);line-height:1.6;margin-bottom:10px}
.drive-buttons{display:flex;gap:8px}
.drive-buttons button{flex:1;padding:10px;border-radius:10px;font-size:.8em;font-weight:700;cursor:pointer;border:1px solid var(--border);-webkit-tap-highlight-color:transparent}
.drive-buttons button:active{transform:scale(.97)}
.drive-buttons .sync-btn{color:#fff;background:var(--success);border-color:var(--success)}
.drive-buttons .load-btn{color:var(--accent);background:var(--accent-bg);border-color:var(--accent)}
.drive-sync-status{font-size:.72em;text-align:center;margin-top:8px;font-weight:600;min-height:1.6em}

@media(max-width:480px){
  .container{padding:8px;padding-bottom:100px}
  .q-card{padding:14px}
  .likert .chip{padding:7px 1px;font-size:.85em}
  .likert .chip-label{font-size:.45em}
  .bar-label{width:58px;font-size:.65em}
  .spectrum-label{width:50px;font-size:.55em}
  .trait-card{padding:14px}
  .calc-row{flex-direction:column;gap:1px}
  .calc-row .calc-formula{text-align:left}
  .interp{flex-direction:column}
}

/* Chat View */
.chat-person-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:12px}
.chat-person-header .name{font-weight:800;font-size:1em;flex:1}
.chat-person-header .meta{font-size:.72em;color:var(--text-muted)}
.chat-messages{display:flex;flex-direction:column;gap:10px;margin-bottom:12px;min-height:100px}
.chat-msg{max-width:88%;padding:12px 16px;border-radius:16px;font-size:.88em;line-height:1.7;word-break:break-word}
.chat-msg.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.chat-msg.ai{align-self:flex-start;background:var(--surface);box-shadow:var(--shadow);border-bottom-left-radius:4px}
.chat-msg.system{align-self:center;background:var(--success-bg);color:#166534;font-size:.78em;text-align:center;border-radius:10px;max-width:95%}
.chat-msg .time{font-size:.62em;opacity:.6;margin-top:4px;display:block}
.chat-input-bar{position:sticky;bottom:0;display:flex;gap:8px;padding:10px 0;background:var(--bg);align-items:flex-end}
.chat-input-bar textarea{flex:1;padding:12px 14px;border:2px solid var(--border);border-radius:16px;font-size:.92em;line-height:1.6;resize:none;outline:none;font-family:inherit;background:var(--surface);min-height:52px;max-height:240px;overflow-y:auto}
.chat-input-bar textarea:focus{border-color:var(--accent)}
.chat-input-bar button{padding:14px 20px;border-radius:16px;border:none;background:var(--accent);color:#fff;font-weight:700;font-size:.88em;cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent;margin-bottom:2px}
.chat-input-bar button:disabled{opacity:.3}
.chat-loading{text-align:center;padding:16px;color:var(--accent);font-size:.82em;font-weight:600}
</style>
</head>
<body>
<div class="container">
  <div class="app-header">
    <h1>Personality Observer</h1>
    <div class="sub">ä»–è€…ã®æ€§æ ¼ãƒ»é©æ€§ã‚’å¤šè§’çš„ã«äºˆæ¸¬ã™ã‚‹ãƒ„ãƒ¼ãƒ«</div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="test" onclick="switchTab('test')">è¨ºæ–­</div>
    <div class="tab" data-tab="ai" onclick="switchTab('ai')">AIåˆ†æ</div>
    <div class="tab" data-tab="list" onclick="switchTab('list')">ä¸€è¦§<span class="badge" id="listBadge" style="display:none">0</span></div>
  </div>

  <!-- ===== TEST VIEW ===== -->
  <div class="view active" id="view-test">
    <!-- Step 1: Setup -->
    <div id="setupPhase">
      <div class="card name-wrap">
        <label>äºˆæ¸¬ã™ã‚‹ç›¸æ‰‹ã®åå‰ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="targetName" placeholder="ä¾‹ï¼šç”°ä¸­ã•ã‚“">
      </div>
      <div style="font-size:.88em;font-weight:700;margin-bottom:10px">å®Ÿæ–½ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¸æŠ</div>
      <div class="module-grid" id="moduleGrid"></div>
      <button class="nav-btn btn-primary" style="width:100%" onclick="startAssessment()">è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <!-- Step 2: Questions -->
    <div id="questionPhase" style="display:none">
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div class="progress-text" id="progressText">0/0</div>
      </div>
      <div id="questionnaire"></div>
      <div class="nav-buttons" id="navButtons">
        <button class="nav-btn btn-secondary" id="prevBtn" onclick="changePage(-1)" disabled>æˆ»ã‚‹</button>
        <button class="nav-btn btn-primary" id="nextBtn" onclick="changePage(1)">æ¬¡ã¸</button>
      </div>
    </div>

    <!-- Step 3: Results -->
    <div id="resultPhase" style="display:none">
      <div class="result-header">
        <h2 id="resultTitle">äºˆæ¸¬çµæœ</h2>
        <div class="date" id="resultDate"></div>
      </div>
      <div id="resultContent"></div>
      <div class="result-actions">
        <button class="nav-btn btn-save" onclick="saveResult()">ä¿å­˜ã™ã‚‹</button>
        <button class="nav-btn btn-ai" onclick="goToAI()">AIã«åˆ†æã—ã¦ã‚‚ã‚‰ã†</button>
        <button class="nav-btn btn-secondary" onclick="resetAll()">æ–°ã—ãè¨ºæ–­</button>
      </div>
    </div>
  </div>

  <!-- ===== AI VIEW ===== -->
  <div class="view" id="view-ai">
    <div class="card api-key-section">
      <label>Anthropic API ã‚­ãƒ¼</label>
      <div class="api-key-row">
        <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
        <button onclick="saveApiKey()">ä¿å­˜</button>
      </div>
      <div style="font-size:.68em;color:var(--text-muted);margin-top:4px">ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</div>
      <div class="model-select">
        <label style="font-size:.8em">ãƒ¢ãƒ‡ãƒ«:
        <select id="modelSelect">
          <option value="claude-sonnet-4-5-20250929">Sonnet 4.5ï¼ˆæ¨å¥¨ï¼‰</option>
          <option value="claude-haiku-4-5-20251001">Haiku 4.5ï¼ˆé«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰</option>
        </select></label>
      </div>
    </div>

    <div class="card">
      <div style="font-size:.88em;font-weight:700;margin-bottom:8px">ã“ã®äººã«ã¤ã„ã¦è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„</div>
      <div style="font-size:.72em;color:var(--text-muted);margin-bottom:8px">ä¸»è¦³ã§OKã€‚ã€Œã“ã†ã„ã†ã¨ã“ã‚ãŒã‚ã‚‹ã€ã€Œã“ã‚“ãªå ´é¢ã‚’è¦‹ãŸã€ãªã©</div>
      <textarea class="ai-textarea" id="aiInput" placeholder="ä¾‹ï¼šæœ€è¿‘çŸ¥ã‚Šåˆã£ãŸäººã§ã€æœ€åˆã¯é™ã‹ã ã£ãŸã‘ã©ä»²è‰¯ããªã‚‹ã¨çµæ§‹æ¯’èˆŒã€‚ä»•äº‹ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒæ—©ã„ã‘ã©é›‘ãªã¨ã“ã‚ã‚‚ã‚ã‚‹ã€‚é£²ã¿ä¼šã§ã¯å¾Œè¼©ã®é¢å€’è¦‹ãŒã„ã„..."></textarea>
      <label class="ai-context-toggle"><input type="checkbox" id="includeScores" checked>ç›´è¿‘ã®è¨ºæ–­çµæœã‚’å«ã‚ã‚‹</label>
      <div class="ai-prompts">
        <span class="ai-prompt-chip" onclick="setAIPrompt('ã“ã®äººã®å¼·ã¿ã¨å¼±ã¿ã‚’åˆ†æã—ã¦')">å¼·ã¿ãƒ»å¼±ã¿</span>
        <span class="ai-prompt-chip" onclick="setAIPrompt('ã“ã®äººã¯ä¿¡é ¼ã§ãã‚‹ã‹ï¼Ÿå¤šè§’çš„ã«è€ƒãˆã¦')">ä¿¡é ¼åº¦</span>
        <span class="ai-prompt-chip" onclick="setAIPrompt('ã“ã®äººã¨ã†ã¾ãä»˜ãåˆã†ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã¯ï¼Ÿ')">ä»˜ãåˆã„æ–¹</span>
        <span class="ai-prompt-chip" onclick="setAIPrompt('ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã—ã¦ã®é©æ€§ã¯ï¼Ÿ')">ãƒ“ã‚¸ãƒã‚¹é©æ€§</span>
        <span class="ai-prompt-chip" onclick="setAIPrompt('ã“ã®äººãŒè¦‹ã›ã¦ã„ãªã„è£ã®é¡”ã®å¯èƒ½æ€§ã¯ï¼Ÿ')">è£ã®é¡”</span>
      </div>
      <button class="nav-btn btn-primary" style="width:100%;background:var(--dark)" onclick="runAI()">åˆ†æã™ã‚‹</button>
      <div style="margin-top:12px;padding-top:12px;border-top:2px solid var(--border)">
        <div style="font-size:.82em;font-weight:700;margin-bottom:8px;color:#059669">ç·åˆã‚³ãƒ¼ãƒãƒ³ã‚°ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼‰</div>
        <div style="font-size:.72em;color:var(--text-muted);margin-bottom:8px">ã“ã®äººã®å…¨ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã€æ€§æ ¼ãƒ»é©æ€§ãƒ»è³‡æœ¬ã‚’æ¨ªæ–­çš„ã«åˆ†æã€‚ã€Œæƒœã—ã„ã¨ã“ã‚ã€ã€Œä¼¸ã°ã›ã°å¤‰ã‚ã‚‹ã¨ã“ã‚ã€ã‚’ã‚³ãƒ¼ãƒãƒ³ã‚°è¦–ç‚¹ã§æç¤ºã—ã¾ã™ã€‚</div>
        <button class="nav-btn" style="width:100%;background:#059669;color:#fff;font-size:.88em" onclick="runCoachingAI()">ç·åˆã‚³ãƒ¼ãƒãƒ³ã‚°åˆ†æ</button>
      </div>
    </div>
    <div id="aiResult"></div>
  </div>

  <!-- ===== LIST VIEW ===== -->
  <div class="view" id="view-list">
    <div class="drive-section" id="driveSection">
      <div class="drive-header" onclick="toggleDrivePanel()">
        <span class="icon">â˜ï¸</span>
        <span class="title">Google Drive åŒæœŸ</span>
        <span class="status off" id="driveStatus">æœªæ¥ç¶š</span>
      </div>
      <div class="drive-body" id="driveBody">
        <div class="drive-help">
          GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
          è¨­å®šæ‰‹é †ã¯ <code>personality-observer-gas.gs</code> ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã€‚
        </div>
        <div class="drive-url-row">
          <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/...">
          <button onclick="saveGasUrl()">ä¿å­˜</button>
        </div>
        <div class="drive-buttons">
          <button class="sync-btn" onclick="syncToDrive()">Driveã«ä¿å­˜</button>
          <button class="load-btn" onclick="loadFromDrive()">Driveã‹ã‚‰èª­è¾¼</button>
        </div>
        <div class="drive-sync-status" id="driveSyncStatus"></div>
      </div>
    </div>
    <div class="data-actions">
      <button class="export-btn" onclick="exportJSON()">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="import-btn" onclick="document.getElementById('importFile').click()">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
    </div>
    <div id="listContent"></div>
  </div>

  <!-- ===== TIMELINE VIEW ===== -->
  <div class="view" id="view-timeline">
    <div class="detail-back" onclick="switchTab('list')">â† ä¸€è¦§ã«æˆ»ã‚‹</div>
    <div id="timelineContent"></div>
  </div>

  <!-- ===== DETAIL VIEW ===== -->
  <div class="view" id="view-detail">
    <div class="detail-back" onclick="switchTab('list')">â† ä¸€è¦§ã«æˆ»ã‚‹</div>
    <div id="detailContent"></div>
  </div>

  <!-- ===== CHAT VIEW ===== -->
  <div class="view" id="view-chat">
    <div class="detail-back" onclick="switchTab('list')">â† ä¸€è¦§ã«æˆ»ã‚‹</div>
    <div class="chat-person-header" id="chatHeader"></div>
    <div id="chatApiKeySection" style="display:none">
      <div class="card" style="border:2px solid var(--danger)">
        <div style="font-size:.88em;font-weight:700;margin-bottom:8px;color:var(--danger)">APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</div>
        <div class="api-key-row">
          <input type="password" id="chatApiKeyInput" placeholder="sk-ant-...">
          <button onclick="saveChatApiKey()" style="background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer">ä¿å­˜ã—ã¦åˆ†æé–‹å§‹</button>
        </div>
        <div style="font-size:.68em;color:var(--text-muted);margin-top:6px">Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-bar">
      <textarea id="chatInput" placeholder="ã“ã®äººã«ã¤ã„ã¦è³ªå•..." rows="2" oninput="autoResize(this)" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button onclick="sendChat()" id="chatSendBtn">é€ä¿¡</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA DEFINITIONS
// ============================================================

const MODULES = {
  bigfive: {
    id:'bigfive', name:'ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–', desc:'æ€§æ ¼ã®5å› å­ï¼ˆåŸºç›¤ï¼‰', color:'#5b6abf', bg:'#eef0ff',
    count:20, selected:true
  },
  dark: {
    id:'dark', name:'ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰', desc:'è£ã®é©æ€§ãƒ»æ¨©åŠ›æ€§', color:'#7c3aed', bg:'#f3eeff',
    count:12, selected:true
  },
  types: {
    id:'types', name:'4ã‚¿ã‚¤ãƒ—', desc:'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«', color:'#0891b2', bg:'#ecfeff',
    count:12, selected:true
  },
  entre: {
    id:'entre', name:'èµ·æ¥­å®¶é©æ€§', desc:'ãƒ“ã‚¸ãƒã‚¹ã®è¡Œå‹•ç‰¹æ€§', color:'#d97706', bg:'#fffbeb',
    count:12, selected:true
  },
  capital: {
    id:'capital', name:'è³‡æœ¬è«–', desc:'ç›®æ¨™é”æˆã®6ã¤ã®ãƒªã‚½ãƒ¼ã‚¹', color:'#059669', bg:'#ecfdf5',
    count:12, selected:true
  }
};

const QUESTIONS = {
  bigfive: [
    {text:"äººã®é›†ã¾ã‚Šã‚„ç¤¾äº¤ã®å ´ã§æ´»ãæ´»ãã—ã¦ã„ã‚‹",hint:"é£²ã¿ä¼šã‚„ã‚¤ãƒ™ãƒ³ãƒˆã§ã®æ§˜å­",trait:"E",r:false},
    {text:"æ§ãˆã‚ã§é™ã‹ãªå°è±¡ãŒã‚ã‚‹",hint:"æ™®æ®µã®è©±ã—æ–¹ã‚„ãƒ†ãƒ³ã‚·ãƒ§ãƒ³",trait:"E",r:true},
    {text:"è‡ªåˆ†ã‹ã‚‰è©±ã—ã‹ã‘ãŸã‚Šä¼šè©±ã‚’ãƒªãƒ¼ãƒ‰ã™ã‚‹",hint:"ã‚°ãƒ«ãƒ¼ãƒ—ã§ã®ç«‹ã¡ä½ç½®",trait:"E",r:false},
    {text:"ä¸€äººã§éã”ã™æ™‚é–“ã®ã»ã†ãŒå¥½ããã†ã ",hint:"ä¼‘æ—¥ã®éã”ã—æ–¹ãƒ»SNSæŠ•ç¨¿",trait:"E",r:true},
    {text:"ä»–äººã«å¯¾ã—ã¦æ¸©ã‹ãè¦ªåˆ‡ã«æ¥ã—ã¦ã„ã‚‹",hint:"åº—å“¡ã‚„å¾Œè¼©ã¸ã®æ…‹åº¦",trait:"A",r:false},
    {text:"ä»–äººã¨è¡çªã—ãŸã‚Šå£è«–ã«ãªã‚‹ã“ã¨ãŒå¤šã„",hint:"æ„è¦‹å¯¾ç«‹æ™‚ã®æŒ¯ã‚‹èˆã„",trait:"A",r:true},
    {text:"å›°ã£ã¦ã„ã‚‹äººã‚’è¦‹ã‹ã‘ãŸã‚‰åŠ©ã‘ã‚ˆã†ã¨ã™ã‚‹",hint:"å®Ÿéš›ã«ãã†ã„ã†å ´é¢ã‚’è¦‹ãŸã‹",trait:"A",r:false},
    {text:"è‡ªåˆ†ã®åˆ©ç›Šã‚’æœ€å„ªå…ˆã«ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹",hint:"åˆ©å®³é–¢ä¿‚ãŒã‚ã‚‹å ´é¢ã§ã®é¸æŠ",trait:"A",r:true},
    {text:"ç‰©äº‹ã‚’ãã¡ã‚“ã¨è¨ˆç”»ã—ã¦ã‹ã‚‰è¡Œå‹•ã™ã‚‹",hint:"ä»•äº‹ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²ã‚æ–¹",trait:"C",r:false},
    {text:"ã ã‚‰ã—ãªã„ã¨ã“ã‚ã‚„é›‘ãªã¨ã“ã‚ãŒã‚ã‚‹",hint:"ãƒ‡ã‚¹ã‚¯å‘¨ã‚Šã€æ™‚é–“ã€ç´„æŸ",trait:"C",r:true},
    {text:"å§‹ã‚ãŸã“ã¨ã¯æœ€å¾Œã¾ã§ã‚„ã‚Šé‚ã’ã‚‹ã‚¿ã‚¤ãƒ—ã ",hint:"é€”ä¸­ã§æŠ•ã’å‡ºã™ã“ã¨ã¯ã‚ã‚‹ã‹",trait:"C",r:false},
    {text:"ç›®ã®å‰ã®æ¥½ã—ã•ã«æµã•ã‚Œã‚„ã™ã„ã¨æ„Ÿã˜ã‚‹",hint:"è¡å‹•è²·ã„ãƒ»å…ˆå»¶ã°ã—å‚¾å‘",trait:"C",r:true},
    {text:"ã‚¹ãƒˆãƒ¬ã‚¹ã‚„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«å¼±ãã†ã ",hint:"ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®åå¿œ",trait:"N",r:false},
    {text:"ã„ã¤ã‚‚è½ã¡ç€ã„ã¦ã„ã¦å‹•ã˜ãªã„å°è±¡ãŒã‚ã‚‹",hint:"äºˆæƒ³å¤–ã®äº‹æ…‹ã§ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³",trait:"N",r:true},
    {text:"ä¸å®‰ã‚„å¿ƒé…äº‹ã‚’æŠ±ãˆã‚„ã™ã„ã‚¿ã‚¤ãƒ—ã«è¦‹ãˆã‚‹",hint:"å°†æ¥ã‚„äº›ç´°ãªã“ã¨ã¸ã®åå¿œ",trait:"N",r:false},
    {text:"æ„Ÿæƒ…ã®æ³¢ãŒå°‘ãªãã„ã¤ã‚‚ãƒ•ãƒ©ãƒƒãƒˆã ",hint:"ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã®ä¸Šä¸‹å¹…",trait:"N",r:true},
    {text:"æ–°ã—ã„ã“ã¨ã‚„æœªçŸ¥ã®çµŒé¨“ã«èˆˆå‘³æ´¥ã€…ã ",hint:"æ–°ã—ã„é£Ÿã¹ç‰©ãƒ»å ´æ‰€ãƒ»è¶£å‘³ã¸ã®åå¿œ",trait:"O",r:false},
    {text:"æ±ºã¾ã£ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚„æ…£ã‚ŒãŸã‚„ã‚Šæ–¹ã‚’å¥½ã‚€",hint:"å¤‰åŒ–ã‚’å«ŒãŒã‚‹ã‹ã€åŒã˜é¸æŠã‚’ã™ã‚‹ã‹",trait:"O",r:true},
    {text:"ç‹¬å‰µçš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚„è¦–ç‚¹ã‚’æŒã£ã¦ã„ã‚‹",hint:"ã€Œã“ã®ç™ºæƒ³ã¯ãªã‹ã£ãŸã€ã¨æ€ã£ãŸã‹",trait:"O",r:false},
    {text:"ç¾å®Ÿçš„ã§åœ°ã«è¶³ãŒã¤ã„ãŸè€ƒãˆæ–¹ã‚’ã™ã‚‹",hint:"ç©ºæƒ³çš„ vs å®Ÿå‹™çš„",trait:"O",r:true},
  ],
  dark: [
    {text:"ç›®çš„ã®ãŸã‚ãªã‚‰æ‰‹æ®µã‚’é¸ã°ãªã„ã¨ã“ã‚ãŒã‚ã‚‹",hint:"äº¤æ¸‰ã‚„é§†ã‘å¼•ãã®å ´é¢",trait:"Mach",r:false},
    {text:"ä»–äººã‚’æ“ä½œã—ãŸã‚Šåˆ©ç”¨ã™ã‚‹ã®ãŒã†ã¾ã„",hint:"äººé–“é–¢ä¿‚ã®æ§‹ç¯‰ãƒ‘ã‚¿ãƒ¼ãƒ³",trait:"Mach",r:false},
    {text:"æœ¬éŸ³ã¨å»ºå‰ã‚’å·§ã¿ã«ä½¿ã„åˆ†ã‘ã‚‹",hint:"ç›¸æ‰‹ã«ã‚ˆã£ã¦æ…‹åº¦ã‚’å¤‰ãˆã‚‹ã‹",trait:"Mach",r:false},
    {text:"é•·æœŸçš„ãªæˆ¦ç•¥ã‚’æŒã£ã¦äººé–“é–¢ä¿‚ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹",hint:"äººä»˜ãåˆã„ã«è¨ˆç®—ãŒè¦‹ãˆã‚‹ã‹",trait:"Mach",r:false},
    {text:"è‡ªåˆ†ãŒç‰¹åˆ¥ãªå­˜åœ¨ã ã¨æ€ã£ã¦ã„ã‚‹ç¯€ãŒã‚ã‚‹",hint:"è‡ªå·±è©•ä¾¡ã®é«˜ã•",trait:"Narc",r:false},
    {text:"æ³¨ç›®ã•ã‚ŒãŸã„ãƒ»èªã‚ã‚‰ã‚ŒãŸã„ã¨ã„ã†æ¬²æ±‚ãŒå¼·ã„",hint:"SNSã‚„ä¼šè©±ã§ã®æ‰¿èªæ¬²æ±‚",trait:"Narc",r:false},
    {text:"æ‰¹åˆ¤ã«å¯¾ã—ã¦éå‰°ã«åå¿œã™ã‚‹",hint:"æŒ‡æ‘˜ã•ã‚ŒãŸæ™‚ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³",trait:"Narc",r:false},
    {text:"è‡ªåˆ†ã®åŠŸç¸¾ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹ã®ãŒå¾—æ„ã ",hint:"å®Ÿç¸¾ã®èªã‚Šæ–¹",trait:"Narc",r:false},
    {text:"ä»–äººã®ç—›ã¿ã‚„è‹¦ã—ã¿ã«ç„¡é–¢å¿ƒã«è¦‹ãˆã‚‹",hint:"èª°ã‹ãŒå›°ã£ã¦ã„ã‚‹æ™‚ã®åå¿œ",trait:"Psych",r:false},
    {text:"å¾Œæ‚”ã‚„ç½ªæ‚ªæ„Ÿã‚’ã‚ã¾ã‚Šæ„Ÿã˜ãªã„ã‚¿ã‚¤ãƒ—ã ",hint:"å¤±æ•—ã‚„ãƒŸã‚¹ã®å¾Œã®æ…‹åº¦",trait:"Psych",r:false},
    {text:"ã‚¹ãƒªãƒ«ã‚„åˆºæ¿€ã‚’æ±‚ã‚ã‚‹å‚¾å‘ãŒã‚ã‚‹",hint:"ãƒªã‚¹ã‚¯ã®ã‚ã‚‹è¡Œå‹•ã¸ã®æ…‹åº¦",trait:"Psych",r:false},
    {text:"ãƒ«ãƒ¼ãƒ«ã‚„ç¤¾ä¼šçš„è¦ç¯„ã‚’è»½è¦–ã™ã‚‹ã¨ã“ã‚ãŒã‚ã‚‹",hint:"æ±ºã¾ã‚Šã”ã¨ã¸ã®æ…‹åº¦",trait:"Psych",r:false},
  ],
  types: [
    {text:"ç‰©äº‹ã®ä¸»å°æ¨©ã‚’æ¡ã‚ŠãŸãŒã‚‹ã‚¿ã‚¤ãƒ—ã ",hint:"ä¼šè­°ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®ç«‹ã¡ä½ç½®",trait:"Controller",r:false},
    {text:"éç¨‹ã‚ˆã‚Šçµæœã‚’é‡è¦–ã™ã‚‹",hint:"ä»•äº‹ã®è©•ä¾¡åŸºæº–",trait:"Controller",r:false},
    {text:"äººã«æŒ‡å›³ã•ã‚Œã‚‹ã®ã‚’å«ŒãŒã‚‹",hint:"ä¸Šå¸ã‚„å…ˆè¼©ã¨ã®é–¢ä¿‚æ€§",trait:"Controller",r:false},
    {text:"æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§äººã‚’å·»ãè¾¼ã‚€ã®ãŒå¾—æ„",hint:"ä¼ç”»ã‚„ææ¡ˆã®å ´é¢",trait:"Promoter",r:false},
    {text:"æ¥½è¦³çš„ã§ã€Œãªã‚“ã¨ã‹ãªã‚‹ã€ã¨è€ƒãˆã‚‹",hint:"å›°é›£ã«ç›´é¢ã—ãŸæ™‚ã®æ…‹åº¦",trait:"Promoter",r:false},
    {text:"æ³¨ç›®ã‚’æµ´ã³ã‚‹ã®ãŒå¥½ãã§å ´ã‚’ç››ã‚Šä¸Šã’ã‚‹",hint:"é£²ã¿ä¼šã‚„ã‚¤ãƒ™ãƒ³ãƒˆã§ã®æŒ¯ã‚‹èˆã„",trait:"Promoter",r:false},
    {text:"äººã®ã‚µãƒãƒ¼ãƒˆã‚„è£æ–¹ã«å›ã‚‹ã“ã¨ãŒå¤šã„",hint:"ãƒãƒ¼ãƒ ã§ã®å½¹å‰²",trait:"Supporter",r:false},
    {text:"å’Œã‚’å¤§åˆ‡ã«ã—ã¦å¯¾ç«‹ã‚’é¿ã‘ã‚‹å‚¾å‘ãŒã‚ã‚‹",hint:"æ„è¦‹ã®é£Ÿã„é•ã„æ™‚ã®å¯¾å¿œ",trait:"Supporter",r:false},
    {text:"è‡ªåˆ†ã®æ„è¦‹ã‚ˆã‚Šç›¸æ‰‹ã®æ°—æŒã¡ã‚’å„ªå…ˆã™ã‚‹",hint:"æ±ºå®šã‚’è¿«ã‚‰ã‚ŒãŸæ™‚ã®åˆ¤æ–­åŸºæº–",trait:"Supporter",r:false},
    {text:"ãƒ‡ãƒ¼ã‚¿ã‚„æ ¹æ‹ ã«åŸºã¥ã„ã¦åˆ¤æ–­ã™ã‚‹",hint:"æ„æ€æ±ºå®šã®ãƒ—ãƒ­ã‚»ã‚¹",trait:"Analyzer",r:false},
    {text:"æ…é‡ã§çŸ³æ©‹ã‚’å©ã„ã¦æ¸¡ã‚‹ã‚¿ã‚¤ãƒ—ã ",hint:"æ–°ã—ã„ã“ã¨ã¸ã®å–ã‚Šçµ„ã¿æ–¹",trait:"Analyzer",r:false},
    {text:"ç´°éƒ¨ã«ã“ã ã‚ã‚ŠãŒã‚ã‚Šå“è³ªã«ã†ã‚‹ã•ã„",hint:"æˆæœç‰©ã®ãƒã‚§ãƒƒã‚¯ã®ä»•æ–¹",trait:"Analyzer",r:false},
  ],
  entre: [
    {text:"å¤±æ•—ã‚’æã‚Œãšã«æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã™ã‚‹",hint:"æœªçµŒé¨“ã®ã“ã¨ã¸ã®æ…‹åº¦",trait:"Risk",r:false},
    {text:"å®‰å®šã‚’æ¨ã¦ã¦å¯èƒ½æ€§ã«è³­ã‘ã‚‹ã‚¿ã‚¤ãƒ—ã ",hint:"ã‚­ãƒ£ãƒªã‚¢ã‚„äººç”Ÿã®é¸æŠ",trait:"Risk",r:false},
    {text:"ãƒªã‚¹ã‚¯ã‚’é¿ã‘ã¦å®‰å…¨ç­–ã‚’å–ã‚‹å‚¾å‘ãŒã‚ã‚‹",hint:"æŠ•è³‡ã‚„ãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­",trait:"Risk",r:true},
    {text:"é•·æœŸç›®æ¨™ã«å‘ã‘ã¦ã‚³ãƒ„ã‚³ãƒ„åŠªåŠ›ã§ãã‚‹",hint:"ç›®æ¨™è¨­å®šã¨è¡Œå‹•ã®ä¸€è²«æ€§",trait:"Grit",r:false},
    {text:"å£ã«ã¶ã¤ã‹ã£ã¦ã‚‚ç°¡å˜ã«ã¯è«¦ã‚ãªã„",hint:"å›°é›£ãªçŠ¶æ³ã§ã®ç²˜ã‚Š",trait:"Grit",r:false},
    {text:"é£½ãã£ã½ãã¦ç¶šã‹ãªã„ã“ã¨ãŒå¤šã„",hint:"è¶£å‘³ã‚„ä»•äº‹ã®ç¶™ç¶šæ€§",trait:"Grit",r:true},
    {text:"ã€Œè‡ªåˆ†ãªã‚‰ã§ãã‚‹ã€ã¨ã„ã†è‡ªä¿¡ãŒã‚ã‚‹",hint:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹æ™‚ã®å§¿å‹¢",trait:"Efficacy",r:false},
    {text:"é›£ã—ã„èª²é¡Œã§ã‚‚å‰å‘ãã«å–ã‚Šçµ„ã‚€",hint:"é›£é¡Œã‚’æŒ¯ã‚‰ã‚ŒãŸæ™‚ã®åå¿œ",trait:"Efficacy",r:false},
    {text:"å¤±æ•—ã™ã‚‹ã¨è‡ªä¿¡ã‚’ãªãã—ã‚„ã™ã„",hint:"æŒ«æŠ˜å¾Œã®ç«‹ã¡ç›´ã‚Š",trait:"Efficacy",r:true},
    {text:"å®Œç’§ã‚’å¾…ãŸãšã«ã¾ãšå§‹ã‚ã‚‹",hint:"æº–å‚™ vs è¡Œå‹•ã®ãƒãƒ©ãƒ³ã‚¹",trait:"Action",r:false},
    {text:"ãƒãƒ£ãƒ³ã‚¹ã‚’è¦‹ã¤ã‘ãŸã‚‰ã™ãé£›ã³ã¤ã",hint:"æ©Ÿä¼šã«å¯¾ã™ã‚‹åå¿œé€Ÿåº¦",trait:"Action",r:false},
    {text:"æº–å‚™ãŒæ•´ã†ã¾ã§ãªã‹ãªã‹å‹•ãå‡ºã•ãªã„",hint:"æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å§‹ã‚æ–¹",trait:"Action",r:true},
  ],
  capital: [
    {text:"çµŒæ¸ˆçš„ã«ä½™è£•ãŒã‚ã‚Šãã†ã§ã€ãŠé‡‘ã®å¿ƒé…ã‚’ã—ã¦ã„ãªã„",hint:"ç”Ÿæ´»æ°´æº–ãƒ»æ¶ˆè²»è¡Œå‹•ãƒ»ãŠé‡‘ã®è©±é¡Œã¸ã®åå¿œ",trait:"Fin",r:false},
    {text:"æŠ•è³‡ã‚„è³‡ç”£å½¢æˆã«ç©æ¥µçš„ã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹",hint:"è³‡ç”£é‹ç”¨ãƒ»å‰¯æ¥­ãƒ»åå…¥æºã®å¤šã•",trait:"Fin",r:false},
    {text:"è‡ªåˆ†ã§ç¨¼ãåŠ›ãŒã‚ã‚Šã€ã©ã“ã§ã‚‚ã‚„ã£ã¦ã„ã‘ãã†ã ",hint:"è»¢è·ãƒ»ç‹¬ç«‹ã—ã¦ã‚‚é£Ÿã£ã¦ã„ã‘ã‚‹æ„Ÿ",trait:"Human",r:false},
    {text:"å¸‚å ´ä¾¡å€¤ã®é«˜ã„ã‚¹ã‚­ãƒ«ã‚„å®Ÿç¸¾ã‚’æŒã£ã¦ã„ã‚‹",hint:"å°‚é–€æ€§ãƒ»ã‚­ãƒ£ãƒªã‚¢ãƒ»äººã‹ã‚‰æ±‚ã‚ã‚‰ã‚Œã‚‹åº¦åˆã„",trait:"Human",r:false},
    {text:"äººè„ˆãŒåºƒãã€å›°ã£ãŸæ™‚ã«é ¼ã‚Œã‚‹äººãŒå¤šãã†ã ",hint:"äº¤å‹é–¢ä¿‚ã®åºƒã•ãƒ»æ·±ã•",trait:"Social",r:false},
    {text:"å‘¨å›²ã‹ã‚‰ä¿¡é ¼ã•ã‚Œã¦ã„ã¦ã€äººæœ›ãŒã‚ã‚‹",hint:"äººã‹ã‚‰ã®è©•åˆ¤ãƒ»ç´¹ä»‹ã•ã‚Œã‚‹é »åº¦",trait:"Social",r:false},
    {text:"å¥åº·çš„ã§ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã«æ´»å‹•ã—ã¦ã„ã‚‹",hint:"ä½“åŠ›ãƒ»æ´»åŠ›ãƒ»ç”Ÿæ´»ç¿’æ…£",trait:"Body",r:false},
    {text:"ä½“èª¿ã‚’å´©ã—ã‚„ã™ã‹ã£ãŸã‚Šã€ç–²ã‚Œã‚„ã™ãã†ã ",hint:"æ¬ å‹¤ãƒ»ä½“èª¿ä¸è‰¯ã®é »åº¦ãƒ»ã‚¹ã‚¿ãƒŸãƒŠ",trait:"Body",r:true},
    {text:"ãƒ¡ãƒ³ã‚¿ãƒ«ãŒå¼·ãã€é€†å¢ƒã§ã‚‚æŠ˜ã‚Œãšã«å‰ã«é€²ã‚ã‚‹",hint:"å›°é›£æ™‚ã®ç«‹ã¡ç›´ã‚Šãƒ»æ‰“ãŸã‚Œå¼·ã•",trait:"Mental",r:false},
    {text:"ã‚¹ãƒˆãƒ¬ã‚¹ã«å¼±ãã€ç²¾ç¥çš„ã«ä¸å®‰å®šã«ãªã‚Šã‚„ã™ã„",hint:"ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ä¸‹ã®æ§˜å­ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«ä¸èª¿",trait:"Mental",r:true},
    {text:"å¹…åºƒã„çŸ¥è­˜ã‚’æŒã£ã¦ã„ã¦ã€å¸¸ã«å­¦ã³ç¶šã‘ã¦ã„ã‚‹",hint:"èª­æ›¸ãƒ»å‹‰å¼·ãƒ»æƒ…å ±åé›†ã®ç¿’æ…£",trait:"Intellect",r:false},
    {text:"å°‚é–€åˆ†é‡ã§æ·±ã„çŸ¥è¦‹ãŒã‚ã‚Šã€äººã«æ•™ãˆã‚‰ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã ",hint:"å‘¨å›²ã‹ã‚‰ç›¸è«‡ã•ã‚Œã‚‹é »åº¦ãƒ»å°‚é–€æ€§ã®æ·±ã•",trait:"Intellect",r:false},
  ]
};

const BF_TRAITS = {
  E:{name:"å¤–å‘æ€§",en:"Extraversion",low:"å†…å‘æ€§",lowEn:"Introversion",color:"#5b6abf",colorLow:"#e07a5f",bg:"#eef0ff",
    facets:{high:["ç¤¾äº¤çš„","æ´»å‹•çš„","è‡ªå·±ä¸»å¼µ","ãƒã‚¸ãƒ†ã‚£ãƒ–"],low:["å†…çœçš„","é™ã‹ã•ã‚’å¥½ã‚€","æ§ãˆã‚","ä¸€äººã®æ™‚é–“"]}},
  A:{name:"å”èª¿æ€§",en:"Agreeableness",low:"å†·é…·æ€§",lowEn:"Antagonism",color:"#3d9b8f",colorLow:"#c0392b",bg:"#e8f6f3",
    facets:{high:["ä¿¡é ¼","åˆ©ä»–çš„","å¾“é †","å„ªã—ã•"],low:["æ‡ç–‘çš„","è‡ªå·±ä¸­å¿ƒçš„","åæŠ—çš„","å†·æ·¡"]}},
  C:{name:"èª å®Ÿæ€§",en:"Conscientiousness",low:"æ€ æƒ°æ€§",lowEn:"Carelessness",color:"#2e86ab",colorLow:"#d68c45",bg:"#e6f2f8",
    facets:{high:["è‡ªå·±è¦å¾‹","è¨ˆç”»æ€§","è²¬ä»»æ„Ÿ","é”æˆå¿—å‘"],low:["è¡å‹•çš„","ç„¡è¨ˆç”»","ä¸æ³¨æ„","æŸ”è»Ÿã™ãã‚‹"]}},
  N:{name:"ç¥çµŒç—‡çš„å‚¾å‘",en:"Neuroticism",low:"æƒ…ç·’å®‰å®šæ€§",lowEn:"Emotional Stability",color:"#c97b2a",colorLow:"#27ae60",bg:"#fdf5e6",
    facets:{high:["ä¸å®‰","æ€’ã‚Šã£ã½ã„","æ†‚ã†ã¤","è‡ªæ„è­˜éå‰°"],low:["å†·é™","ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§","å®‰å®š","è‡ªä¿¡"]}},
  O:{name:"é–‹æ”¾æ€§",en:"Openness",low:"é–‰é–æ€§",lowEn:"Closed-mindedness",color:"#8b5cf6",colorLow:"#7f8c8d",bg:"#f3eeff",
    facets:{high:["å¥½å¥‡å¿ƒ","æƒ³åƒåŠ›","èŠ¸è¡“çš„æ„Ÿæ€§","çŸ¥çš„æ¢æ±‚"],low:["ä¿å®ˆçš„","å®Ÿå‹™çš„","æ…£ç¿’é‡è¦–","å¤‰åŒ–å«Œã„"]}}
};
const BF_ORDER = ["E","A","C","N","O"];

const DARK_TRAITS = {
  Mach:{name:"ãƒã‚­ãƒ£ãƒ™ãƒªã‚ºãƒ ",en:"Machiavellianism",color:"#7c3aed",bg:"#f3eeff",
    biz:"æˆ¦ç•¥çš„æ€è€ƒãƒ»æ ¹å›ã—ãƒ»é•·æœŸçš„äººè„ˆæ§‹ç¯‰",shadow:"ä»–äººã‚’é“å…·ã¨ã—ã¦åˆ©ç”¨ãƒ»ä¿¡é ¼é–¢ä¿‚ã®æ¬ å¦‚"},
  Narc:{name:"ãƒŠãƒ«ã‚·ã‚·ã‚ºãƒ ",en:"Narcissism",color:"#ec4899",bg:"#fdf2f8",
    biz:"è‡ªä¿¡ãƒ»ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ»ã‚«ãƒªã‚¹ãƒæ€§",shadow:"å…±æ„ŸåŠ›ä¸è¶³ãƒ»æ‰¹åˆ¤ã¸ã®è„†å¼±æ€§ãƒ»æ¾å–çš„"},
  Psych:{name:"ã‚µã‚¤ã‚³ãƒ‘ã‚·ãƒ¼",en:"Psychopathy",color:"#475569",bg:"#f1f5f9",
    biz:"å†·é™ãªæ„æ€æ±ºå®šãƒ»å¤§èƒ†ãªè¡Œå‹•ãƒ»ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼è€æ€§",shadow:"è‰¯å¿ƒã®æ¬ å¦‚ãƒ»è¡å‹•çš„ãƒ»åç¤¾ä¼šçš„è¡Œå‹•"}
};
const DARK_ORDER = ["Mach","Narc","Psych"];

const TYPE_TRAITS = {
  Controller:{name:"ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼",color:"#dc2626",bg:"#fef2f2",desc:"çµæœé‡è¦–ãƒ»ä¸»å°çš„ãƒ»åŠ¹ç‡è¿½æ±‚ã€‚æŒ‡ç¤ºã•ã‚Œã‚‹ã®ã‚’å«Œã„ã€è‡ªåˆ†ã§æ±ºã‚ãŸã„ã€‚è©±ã¯çµè«–ã‹ã‚‰ã€‚",comm:"çµè«–ã‹ã‚‰ä¼ãˆã‚‹ã€‚é¸æŠè‚¢ã‚’æç¤ºã—ã¦é¸ã°ã›ã‚‹ã€‚æ™‚é–“ã‚’å¥ªã‚ãªã„ã€‚"},
  Promoter:{name:"ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼",color:"#ea580c",bg:"#fff7ed",desc:"æ¥½è¦³çš„ãƒ»å·»ãè¾¼ã¿ä¸Šæ‰‹ãƒ»ãƒ“ã‚¸ãƒ§ãƒ³å‹ã€‚ç´°ã‹ã„ã“ã¨ã‚ˆã‚Šå¤§ããªçµµã‚’æãã€‚ãƒãƒªã¨å‹¢ã„ã€‚",comm:"ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹æœªæ¥ã‚’èªã‚‹ã€‚ç´°ã‹ã„è©±ã¯å¾Œå›ã—ã€‚è¤’ã‚ã¦ãƒã‚»ã‚‹ã€‚"},
  Supporter:{name:"ã‚µãƒãƒ¼ã‚¿ãƒ¼",color:"#16a34a",bg:"#f0fdf4",desc:"å”åŠ›çš„ãƒ»å…±æ„Ÿçš„ãƒ»å’Œã‚’é‡ã‚“ã˜ã‚‹ã€‚äººã®å½¹ã«ç«‹ã¤ã“ã¨ã«å–œã³ã‚’æ„Ÿã˜ã‚‹ã€‚å¯¾ç«‹ã‚’é¿ã‘ã‚‹ã€‚",comm:"å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹ã€‚æ„Ÿè¬ã‚’ä¼ãˆã‚‹ã€‚æ€¥ã‹ã•ãªã„ã€‚æ„è¦‹ã‚’ä¸å¯§ã«èãã€‚"},
  Analyzer:{name:"ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼",color:"#2563eb",bg:"#eff6ff",desc:"åˆ†æçš„ãƒ»æ…é‡ãƒ»å®Œç’§ä¸»ç¾©ã€‚ãƒ‡ãƒ¼ã‚¿ã¨æ ¹æ‹ ã§åˆ¤æ–­ã™ã‚‹ã€‚æ­£ç¢ºã•ã«ã“ã ã‚ã‚‹ã€‚",comm:"æ ¹æ‹ ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ç¤ºã™ã€‚è€ƒãˆã‚‹æ™‚é–“ã‚’ä¸ãˆã‚‹ã€‚æ›–æ˜§ãªæŒ‡ç¤ºã‚’é¿ã‘ã‚‹ã€‚"}
};
const TYPE_ORDER = ["Controller","Promoter","Supporter","Analyzer"];

const ENTRE_TRAITS = {
  Risk:{name:"ãƒªã‚¹ã‚¯è¨±å®¹åº¦",color:"#dc2626",bg:"#fef2f2"},
  Grit:{name:"ã‚°ãƒªãƒƒãƒˆï¼ˆã‚„ã‚ŠæŠœãåŠ›ï¼‰",color:"#d97706",bg:"#fffbeb"},
  Efficacy:{name:"è‡ªå·±åŠ¹åŠ›æ„Ÿ",color:"#16a34a",bg:"#f0fdf4"},
  Action:{name:"è¡Œå‹•ãƒã‚¤ã‚¢ã‚¹",color:"#2563eb",bg:"#eff6ff"}
};
const ENTRE_ORDER = ["Risk","Grit","Efficacy","Action"];

const CAPITAL_TRAITS = {
  Fin:{name:"é‡‘èè³‡æœ¬",en:"Financial Capital",color:"#ca8a04",bg:"#fefce8",icon:"ğŸ’°",desc:"ãŠé‡‘ãƒ»è³‡ç”£ãƒ»çµŒæ¸ˆçš„åŸºç›¤"},
  Human:{name:"äººçš„è³‡æœ¬",en:"Human Capital",color:"#d97706",bg:"#fffbeb",icon:"âš¡",desc:"ç¨¼ãåŠ›ãƒ»ã‚­ãƒ£ãƒªã‚¢ãƒ»å¸‚å ´ä¾¡å€¤"},
  Social:{name:"ç¤¾ä¼šè³‡æœ¬",en:"Social Capital",color:"#0891b2",bg:"#ecfeff",icon:"ğŸ¤",desc:"äººè„ˆãƒ»ä¿¡é ¼ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£"},
  Body:{name:"èº«ä½“è³‡æœ¬",en:"Physical Capital",color:"#dc2626",bg:"#fef2f2",icon:"ğŸ’ª",desc:"å¥åº·ãƒ»ä½“åŠ›ãƒ»è‹¥ã•"},
  Mental:{name:"ç²¾ç¥è³‡æœ¬",en:"Mental Capital",color:"#7c3aed",bg:"#f3eeff",icon:"ğŸ§ ",desc:"ãƒ¡ãƒ³ã‚¿ãƒ«ã®å¼·ã•ãƒ»ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹"},
  Intellect:{name:"çŸ¥è­˜è³‡æœ¬",en:"Intellectual Capital",color:"#2563eb",bg:"#eff6ff",icon:"ğŸ“š",desc:"å°‚é–€çŸ¥è­˜ãƒ»å­¦ç¿’åŠ›ãƒ»çŸ¥çš„å¥½å¥‡å¿ƒ"}
};
const CAPITAL_ORDER = ["Fin","Human","Social","Body","Mental","Intellect"];

// ============================================================
// COACHING SYSTEM PROMPT (shared)
// ============================================================
const COACHING_SYSTEM_PROMPT = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚³ãƒ¼ãƒãƒ³ã‚°å°‚é–€å®¶ã§ã‚ã‚Šã€æ€§æ ¼å¿ƒç†å­¦ãƒ»è¡Œå‹•ç§‘å­¦ãƒ»æ©˜ç²ã€Œå¹¸ç¦ã®è³‡æœ¬è«–ã€ã«ç²¾é€šã—ã¦ã„ã¾ã™ã€‚

**æ ¸ã¨ãªã‚‹è€ƒãˆæ–¹**:
- 6ã¤ã®è³‡æœ¬ï¼ˆé‡‘èãƒ»äººçš„ãƒ»ç¤¾ä¼šãƒ»èº«ä½“ãƒ»ç²¾ç¥ãƒ»çŸ¥è­˜ï¼‰ã¯ç›®æ¨™é”æˆã®ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹
- 2ã¤ä»¥ä¸Šã®è³‡æœ¬ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ç›®æ¨™é”æˆã®å¯èƒ½æ€§ãŒé£›èºçš„ã«é«˜ã¾ã‚‹
- æ€§æ ¼ç‰¹æ€§ï¼ˆãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–ç­‰ï¼‰ã¯è³‡æœ¬ã®æ´»ã‹ã—æ–¹ã‚„ä¼¸ã°ã—æ–¹ã«å½±éŸ¿ã™ã‚‹

**éš ã‚ŒãŸç‰¹æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª­ã¿å–ã‚Šï¼ˆé‡è¦ï¼‰**:
ãƒ‡ãƒ¼ã‚¿ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹æ€§ã®ã€Œå‚¾å‘ã€ãŒè¦‹ãˆã‚‹å ´åˆã¯å¿…ãšè¨€åŠã—ã¦ãã ã•ã„ã€‚
è‡¨åºŠè¨ºæ–­ã§ã¯ãªãã€ã‚ãã¾ã§ã€Œã“ã®å‚¾å‘ãŒã‚ã‚Šãã†ã€ã€Œæ„è­˜ã™ã‚‹ã¨æ´»ã‹ã›ã‚‹ã€ã¨ã„ã†è¦–ç‚¹ã§ã€‚

- **ADHDå‚¾å‘**: èª å®Ÿæ€§ãŒä½ã„ï¼ˆè¡å‹•ãƒ»ç„¡è¨ˆç”»ï¼‰+ é–‹æ”¾æ€§orè¡Œå‹•ãƒã‚¤ã‚¢ã‚¹ãŒé«˜ã„ â†’ ãƒã‚¤ãƒ‘ãƒ¼ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å‹ã®å¯èƒ½æ€§ã€çŸ­æœŸé›†ä¸­ã§æˆæœã‚’å‡ºã™è¨­è¨ˆãŒæœ‰åŠ¹
- **HSP/ã‚¨ãƒ³ãƒ‘ã‚¹å‚¾å‘**: å”èª¿æ€§ãŒæ¥µç«¯ã«é«˜ã„ + ç¥çµŒç—‡çš„å‚¾å‘ãŒé«˜ã„ â†’ å…±æ„Ÿç–²ã‚Œãƒªã‚¹ã‚¯ã€ä»–äººã®æ„Ÿæƒ…ã‚’æ‹¾ã„ã™ãã‚‹ã€‚ç’°å¢ƒé¸ã³ãŒé‡è¦
- **é¬±å‚¾å‘**: ç¥çµŒç—‡çš„å‚¾å‘ãŒé«˜ã„ + å¤–å‘æ€§ãŒä½ã„ + ç²¾ç¥è³‡æœ¬ãŒä½ã„ â†’ ã‚¨ãƒãƒ«ã‚®ãƒ¼ç®¡ç†ãŒæœ€å„ªå…ˆèª²é¡Œ
- **èºé¬±å‚¾å‘**: æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã§ã‚¹ã‚³ã‚¢ã®æŒ¯ã‚Œå¹…ãŒå¤§ãã„ â†’ æ³¢ã‚’åˆ©ç”¨ã™ã‚‹æˆ¦ç•¥ï¼ˆèºã®æ™‚ã«ä»•è¾¼ã¿ã€é¬±ã®æ™‚ã¯å®ˆã‚Šï¼‰
- **ASDå‚¾å‘**: å”èª¿æ€§ãŒä½ã„ + èª å®Ÿæ€§oré–‹æ”¾æ€§ãŒæ¥µç«¯ã«é«˜ã„ + ã‚µãƒãƒ¼ã‚¿ãƒ¼ãŒæ¥µç«¯ã«ä½ã„ â†’ æ§‹é€ åŒ–ã•ã‚ŒãŸç’°å¢ƒã§å¼·ã¿ãŒæ´»ãã‚‹
- **ãƒŠãƒ«ã‚·ã‚·ã‚¹ãƒˆÃ—é«˜èƒ½åŠ›**: ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰ã®ãƒŠãƒ«ã‚·ã‚·ã‚ºãƒ ãŒé«˜ã„ + äººçš„è³‡æœ¬orçŸ¥è­˜è³‡æœ¬ãŒé«˜ã„ â†’ ã‚«ãƒªã‚¹ãƒå‹ãƒªãƒ¼ãƒ€ãƒ¼ã®ç´ è³ªã€ãŸã ã—å…±æ„ŸåŠ›ã®è£œå®ŒãŒå¿…è¦
- **å›é¿å‹**: ç¥çµŒç—‡çš„å‚¾å‘ãŒé«˜ã„ + ãƒªã‚¹ã‚¯è¨±å®¹åº¦ãŒä½ã„ + è¡Œå‹•ãƒã‚¤ã‚¢ã‚¹ãŒä½ã„ â†’ å®‰å…¨åœã‚’å°‘ã—ãšã¤åºƒã’ã‚‹ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ãŒæœ‰åŠ¹

â€» ä¸Šè¨˜ã«è©²å½“ã—ãã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ãˆãŸã‚‰ã€ã€Œã“ã†ã„ã†å‚¾å‘ãŒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ã€ã¨æŒ‡æ‘˜ã—ãŸä¸Šã§ã€ã€Œã ã‹ã‚‰ã“ãã“ã†ã™ã‚‹ã¨æ´»ãã‚‹ã€ã¨ã„ã†ãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ´»ç”¨æ³•ã‚’å¿…ãšã‚»ãƒƒãƒˆã§æç¤ºã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®æ§‹æˆã§ã‚³ãƒ¼ãƒãƒ³ã‚°åˆ†æã‚’è¡Œã„ã€ãã®å¾Œã®è³ªå•ã«ã‚‚ç­”ãˆã¦ãã ã•ã„ï¼š

## 1. ã“ã®äººã®ç¾åœ¨åœ°ï¼ˆå¼·ã¿ãƒ»æ­¦å™¨ï¼‰
- å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¨ªæ–­ã—ã¦ã€ã“ã®äººãŒä»ŠæŒã£ã¦ã„ã‚‹æœ€å¤§ã®æ­¦å™¨ã‚’ç‰¹å®š
- æ€§æ ¼Ã—è³‡æœ¬ã®çµ„ã¿åˆã‚ã›ã§è¦‹ãˆã‚‹å¼·ã¿

## 2. éš ã‚ŒãŸç‰¹æ€§ãƒ»å‚¾å‘
- ãƒ‡ãƒ¼ã‚¿ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ç‰¹æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¸Šè¨˜å‚ç…§ï¼‰
- ãã®ç‰¹æ€§ã‚’ã€Œæ‰±ãˆãŸã‚‰å¼·ã„æ­¦å™¨ã€ã«å¤‰ãˆã‚‹æ–¹æ³•

## 3. æƒœã—ã„ã¨ã“ã‚ï¼ˆã‚ã¨å°‘ã—ã§åŒ–ã‘ã‚‹ï¼‰
- ã€Œã»ã‚“ã®å°‘ã—ä¼¸ã°ã›ã°å¤§ããå¤‰ã‚ã‚‹ã€èƒ½åŠ›ãƒ»è³‡æœ¬ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜
- ãªãœãã‚ŒãŒæƒœã—ã„ã®ã‹ã€æ•°å€¤æ ¹æ‹ ã¨ã¨ã‚‚ã«

## 4. ç›´ã™ã¹ãã¨ã“ã‚ï¼ˆè¶³ã‚’å¼•ã£å¼µã£ã¦ã„ã‚‹è¦ç´ ï¼‰
- æ€§æ ¼ç‰¹æ€§ã‚„ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰ã®ä¸­ã§ã€ç›®æ¨™é”æˆã‚’å¦¨ã’ã¦ã„ã‚‹è¦ç´ 
- æœ¬äººãŒæ°—ã¥ã„ã¦ã„ãªã„å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚«ãƒ¼

## 5. ãƒªã‚½ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›æˆ¦ç•¥
- ä»Šã‚ã‚‹è³‡æœ¬ã§ã©ã‚“ãªç›®æ¨™ãŒé”æˆå¯èƒ½ã‹
- ã€Œã‚‚ã—â—‹â—‹è³‡æœ¬ã‚’3.5ä»¥ä¸Šã¾ã§ä¸Šã’ãŸã‚‰ã€â–³â–³ã¨æ›ã‘åˆã‚ã›ã¦ã“ã†ãªã‚Œã‚‹ã€ã¨ã„ã†å…·ä½“çš„ã‚·ãƒŠãƒªã‚ª

## 6. å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³
- ä»Šæ—¥ã‹ã‚‰ã§ãã‚‹3ã¤ã®è¡Œå‹•ææ¡ˆ
- çŸ­æœŸï¼ˆ1ãƒ¶æœˆï¼‰ã¨ä¸­æœŸï¼ˆåŠå¹´ï¼‰ã®ç›®æ¨™è¨­å®š

å¿–åº¦ã›ãšç‡ç›´ã«ã€‚ä¸€èˆ¬è«–ã§ã¯ãªãã€ã“ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªåˆ†æã‚’ã€‚æ—¥æœ¬èªã§å›ç­”ã€‚`;

// ============================================================
// STATE
// ============================================================
let answers = {};
let activeModules = [];
let allQuestions = [];
let currentPage = 0;
let lastScores = null;
let lastTargetName = '';
const QS_PER_PAGE = 4;
const STORAGE_KEY = 'personality_observer_v2';

// ============================================================
// TABS
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-'+tab).classList.add('active');
  if (tab==='list') renderList();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ============================================================
// MODULE SELECTION
// ============================================================
function renderModuleGrid() {
  const grid = document.getElementById('moduleGrid');
  grid.innerHTML = Object.values(MODULES).map(m => `
    <div class="module-card ${m.selected?'selected':''}" onclick="toggleModule('${m.id}')" style="${m.selected?'border-color:'+m.color+';background:'+m.bg:''}">
      <div class="module-check" style="${m.selected?'background:'+m.color+';border-color:'+m.color:''}">
        ${m.selected?'âœ“':''}
      </div>
      <div class="module-info">
        <div class="name" style="color:${m.color}">${m.name}</div>
        <div class="desc">${m.desc}</div>
        <div class="count" style="color:${m.color}">${m.count}å•</div>
      </div>
    </div>
  `).join('');
}

function toggleModule(id) {
  MODULES[id].selected = !MODULES[id].selected;
  renderModuleGrid();
}

// ============================================================
// START ASSESSMENT
// ============================================================
function startAssessment() {
  activeModules = Object.values(MODULES).filter(m => m.selected).map(m => m.id);
  if (activeModules.length === 0) { alert('å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„'); return; }

  // Build question list
  allQuestions = [];
  activeModules.forEach(mid => {
    QUESTIONS[mid].forEach((q, i) => {
      allQuestions.push({...q, module: mid, originalIndex: i});
    });
  });

  answers = {};
  currentPage = 0;

  document.getElementById('setupPhase').style.display = 'none';
  document.getElementById('questionPhase').style.display = 'block';
  renderQuestions();
}

// ============================================================
// QUESTIONS
// ============================================================
function renderQuestions() {
  const c = document.getElementById('questionnaire');
  c.innerHTML = '';
  const start = currentPage * QS_PER_PAGE;
  const end = Math.min(start + QS_PER_PAGE, allQuestions.length);

  let lastModule = null;
  for (let i = start; i < end; i++) {
    const q = allQuestions[i];
    const mod = MODULES[q.module];
    if (q.module !== lastModule) {
      lastModule = q.module;
      // Check if this is first question of this module in the page
      const modStart = allQuestions.findIndex(qq => qq.module === q.module);
      if (i === modStart || start <= modStart) {
        // Only show header at actual start of module
      }
    }
    const card = document.createElement('div');
    card.className = 'q-card';
    card.style.borderLeftColor = mod.color;
    const tagStyle = `background:${mod.bg};color:${mod.color}`;
    const chipBg = mod.color;
    card.innerHTML = `
      <div class="q-meta">
        <span class="q-num" style="color:${mod.color}">Q${i+1}/${allQuestions.length}</span>
        <span class="q-tag" style="${tagStyle}">${mod.name}${q.r?' (R)':''}</span>
      </div>
      <div class="q-text">ã“ã®äººã¯ã€${q.text}</div>
      <div class="q-hint">${q.hint}</div>
      <div class="likert">
        ${[1,2,3,4,5].map(v => `
          <label><input type="radio" name="q${i}" value="${v}" ${answers[i]===v?'checked':''} onchange="setAnswer(${i},${v})">
          <span class="chip" style="${answers[i]===v?'background:'+chipBg+';border-color:'+chipBg:''}">${v}<span class="chip-label">${['å…¨ã\nãªã„','ã‚ã¾ã‚Š\nãªã„','ã©ã¡ã‚‰\nã¨ã‚‚','ã‚„ã‚„\nãã†','éå¸¸ã«\nãã†'][v-1]}</span></span></label>
        `).join('')}
      </div>`;
    c.appendChild(card);
  }
  updateNav();
}

function setAnswer(i, v) { answers[i] = v; updateNav(); }

function updateNav() {
  const count = Object.keys(answers).length;
  const total = allQuestions.length;
  const pct = count / total * 100;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressFill').style.background = `linear-gradient(90deg, ${MODULES[activeModules[0]].color}, ${MODULES[activeModules[activeModules.length-1]].color})`;
  document.getElementById('progressText').textContent = `${count}/${total}`;
  document.getElementById('prevBtn').disabled = currentPage === 0;
  const start = currentPage * QS_PER_PAGE;
  const end = Math.min(start + QS_PER_PAGE, total);
  const allAnswered = Array.from({length: end-start}, (_,j) => answers[start+j]).every(a => a != null);
  const isLast = currentPage === Math.ceil(total / QS_PER_PAGE) - 1;
  const btn = document.getElementById('nextBtn');
  btn.disabled = !allAnswered;
  btn.textContent = isLast ? 'çµæœã‚’è¦‹ã‚‹' : 'æ¬¡ã¸';
}

function changePage(dir) {
  const totalPages = Math.ceil(allQuestions.length / QS_PER_PAGE);
  if (dir > 0 && currentPage === totalPages - 1) { showResults(); return; }
  currentPage += dir;
  renderQuestions();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ============================================================
// SCORING
// ============================================================
function calcAllScores(ans) {
  ans = ans || answers;
  const result = {};

  if (activeModules.includes('bigfive')) {
    result.bigfive = {};
    BF_ORDER.forEach(t => { result.bigfive[t] = {items:[], total:0, avg:0, avgR:0}; });
    allQuestions.forEach((q, i) => {
      if (q.module !== 'bigfive') return;
      const raw = ans[i], eff = q.r ? (6-raw) : raw;
      result.bigfive[q.trait].items.push({idx:i, text:q.text, raw, eff, r:q.r});
    });
    BF_ORDER.forEach(t => {
      const s = result.bigfive[t];
      s.total = s.items.reduce((a,b) => a+b.eff, 0);
      s.avg = s.total / s.items.length;
      s.avgR = 6 - s.avg;
    });
  }

  if (activeModules.includes('dark')) {
    result.dark = {};
    DARK_ORDER.forEach(t => { result.dark[t] = {items:[], total:0, avg:0}; });
    allQuestions.forEach((q, i) => {
      if (q.module !== 'dark') return;
      result.dark[q.trait].items.push({idx:i, text:q.text, raw:ans[i]});
    });
    DARK_ORDER.forEach(t => {
      const s = result.dark[t];
      s.total = s.items.reduce((a,b) => a+b.raw, 0);
      s.avg = s.total / s.items.length;
    });
  }

  if (activeModules.includes('types')) {
    result.types = {};
    TYPE_ORDER.forEach(t => { result.types[t] = {items:[], total:0, avg:0}; });
    allQuestions.forEach((q, i) => {
      if (q.module !== 'types') return;
      result.types[q.trait].items.push({idx:i, text:q.text, raw:ans[i]});
    });
    TYPE_ORDER.forEach(t => {
      const s = result.types[t];
      s.total = s.items.reduce((a,b) => a+b.raw, 0);
      s.avg = s.total / s.items.length;
    });
  }

  if (activeModules.includes('entre')) {
    result.entre = {};
    ENTRE_ORDER.forEach(t => { result.entre[t] = {items:[], total:0, avg:0}; });
    allQuestions.forEach((q, i) => {
      if (q.module !== 'entre') return;
      const raw = ans[i], eff = q.r ? (6-raw) : raw;
      result.entre[q.trait].items.push({idx:i, text:q.text, raw, eff, r:q.r});
    });
    ENTRE_ORDER.forEach(t => {
      const s = result.entre[t];
      s.total = s.items.reduce((a,b) => a+b.eff, 0);
      s.avg = s.total / s.items.length;
    });
  }

  if (activeModules.includes('capital')) {
    result.capital = {};
    CAPITAL_ORDER.forEach(t => { result.capital[t] = {items:[], total:0, avg:0}; });
    allQuestions.forEach((q, i) => {
      if (q.module !== 'capital') return;
      const raw = ans[i], eff = q.r ? (6-raw) : raw;
      result.capital[q.trait].items.push({idx:i, text:q.text, raw, eff, r:q.r});
    });
    CAPITAL_ORDER.forEach(t => {
      const s = result.capital[t];
      s.total = s.items.reduce((a,b) => a+b.eff, 0);
      s.avg = s.total / s.items.length;
    });
  }

  return result;
}

// ============================================================
// SHOW RESULTS
// ============================================================
function showResults() {
  document.getElementById('questionPhase').style.display = 'none';
  document.getElementById('resultPhase').style.display = 'block';

  lastTargetName = document.getElementById('targetName').value.trim() || 'å¯¾è±¡è€…';
  document.getElementById('resultTitle').textContent = lastTargetName + ' ã®äºˆæ¸¬çµæœ';
  document.getElementById('resultDate').textContent = new Date().toLocaleDateString('ja-JP');

  lastScores = calcAllScores();
  renderAllResults(lastScores, lastTargetName, 'resultContent');
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderAllResults(scores, name, containerId) {
  const c = document.getElementById(containerId);
  c.innerHTML = '';

  // Big Five
  if (scores.bigfive) {
    c.innerHTML += `<div class="section-title"><span class="dot" style="background:#5b6abf"></span>ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–ï¼ˆæ€§æ ¼ã®åŸºç›¤ï¼‰</div>`;
    c.innerHTML += `<div class="radar-section"><h3>å…¨ä½“ãƒãƒƒãƒ—</h3><canvas id="radar_${containerId}" width="360" height="360"></canvas>
      <div class="legend"><span><span class="legend-dot" style="background:#5b6abf"></span>æ­£ä½ç›¸</span><span><span class="legend-dot" style="background:#e74c3c"></span>é€†ä½ç›¸</span></div></div>`;
    BF_ORDER.forEach(t => { c.innerHTML += renderBFCard(scores.bigfive[t], BF_TRAITS[t]); });
    setTimeout(() => drawRadar(scores.bigfive, 'radar_'+containerId), 50);
  }

  // Dark Triad
  if (scores.dark) {
    c.innerHTML += `<div class="section-title"><span class="dot" style="background:#7c3aed"></span>ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰ï¼ˆè£ã®é©æ€§ï¼‰</div>`;
    const darkTotal = DARK_ORDER.reduce((a,t) => a + scores.dark[t].avg, 0) / 3;
    c.innerHTML += `<div class="card" style="text-align:center;font-size:.82em;color:var(--text-muted)">ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰ç·åˆ: <b style="color:#7c3aed">${darkTotal.toFixed(2)}</b> / 5.00<br><span style="font-size:.85em">${darkTotal>=3.5?'ã‹ãªã‚Šé«˜ã‚ â€” æˆ¦ç•¥çš„ã ãŒè¦æ³¨æ„':darkTotal>=2.5?'ä¸­ç¨‹åº¦ â€” ãƒãƒ©ãƒ³ã‚¹å‹':'ä½ã‚ â€” ç´ ç›´ã§å”èª¿çš„'}</span></div>`;
    DARK_ORDER.forEach(t => { c.innerHTML += renderDarkCard(scores.dark[t], DARK_TRAITS[t]); });
  }

  // 4 Types
  if (scores.types) {
    c.innerHTML += `<div class="section-title"><span class="dot" style="background:#0891b2"></span>4ã‚¿ã‚¤ãƒ—ï¼ˆã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰</div>`;
    const sorted = [...TYPE_ORDER].sort((a,b) => scores.types[b].avg - scores.types[a].avg);
    const primary = sorted[0], secondary = sorted[1];
    const pt = TYPE_TRAITS[primary], st = TYPE_TRAITS[secondary];
    c.innerHTML += `<div class="type-highlight" style="background:${pt.bg};border:2px solid ${pt.color}">
      <div class="label" style="color:${pt.color}">ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒ—</div>
      <div class="primary" style="color:${pt.color}">${pt.name}</div>
      <div class="sub">ã‚µãƒ–: <b style="color:${st.color}">${st.name}</b></div>
    </div>`;
    c.innerHTML += `<div class="card" style="font-size:.82em"><b style="color:${pt.color}">${pt.name}ã®ç‰¹å¾´ï¼š</b><br>${pt.desc}<br><br><b>æ¥ã—æ–¹ã®ã‚³ãƒ„ï¼š</b><br>${pt.comm}</div>`;
    TYPE_ORDER.forEach(t => { c.innerHTML += renderTypeCard(scores.types[t], TYPE_TRAITS[t], t===primary); });
  }

  // Entrepreneurial
  if (scores.entre) {
    c.innerHTML += `<div class="section-title"><span class="dot" style="background:#d97706"></span>èµ·æ¥­å®¶é©æ€§ï¼ˆãƒ“ã‚¸ãƒã‚¹è¡Œå‹•ç‰¹æ€§ï¼‰</div>`;
    const entreAvg = ENTRE_ORDER.reduce((a,t) => a + scores.entre[t].avg, 0) / 4;
    c.innerHTML += `<div class="card" style="text-align:center;font-size:.82em">èµ·æ¥­å®¶é©æ€§ã‚¹ã‚³ã‚¢: <b style="color:#d97706">${entreAvg.toFixed(2)}</b> / 5.00<br><span style="font-size:.85em;color:var(--text-muted)">${entreAvg>=4?'éå¸¸ã«é«˜ã„èµ·æ¥­å®¶ãƒã‚¤ãƒ³ãƒ‰':entreAvg>=3.5?'èµ·æ¥­å®¶æ°—è³ªã‚ã‚Š':entreAvg>=2.5?'ãƒãƒ©ãƒ³ã‚¹å‹ â€” ç’°å¢ƒæ¬¡ç¬¬':entreAvg>=2?'å®‰å®šå¿—å‘ãŒå¼·ã‚':'èµ·æ¥­ã‚ˆã‚Šé›‡ç”¨å‘ã'}</span></div>`;
    ENTRE_ORDER.forEach(t => { c.innerHTML += renderEntreCard(scores.entre[t], ENTRE_TRAITS[t]); });
  }

  // Capital
  if (scores.capital) {
    c.innerHTML += `<div class="section-title"><span class="dot" style="background:#059669"></span>è³‡æœ¬è«–ï¼ˆç›®æ¨™é”æˆã®ãƒªã‚½ãƒ¼ã‚¹ï¼‰</div>`;
    // Resource map - which capitals are strong (>=3.5)
    const strong = CAPITAL_ORDER.filter(t => scores.capital[t].avg >= 3.5);
    const weak = CAPITAL_ORDER.filter(t => scores.capital[t].avg < 2.5);
    const mid = CAPITAL_ORDER.filter(t => scores.capital[t].avg >= 2.5 && scores.capital[t].avg < 3.5);
    let mapHtml = `<div class="card"><div style="font-size:.88em;font-weight:700;margin-bottom:10px;color:#059669">ãƒªã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—</div>`;
    mapHtml += `<div style="font-size:.78em;color:var(--text-muted);margin-bottom:8px">â€» 2ã¤ä»¥ä¸Šã®è³‡æœ¬ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ç›®æ¨™é”æˆã®å¯èƒ½æ€§ãŒé«˜ã¾ã‚‹</div>`;
    if (strong.length) mapHtml += `<div style="margin-bottom:6px"><b style="color:var(--success);font-size:.82em">å¼·ã„è³‡æœ¬ï¼ˆ3.5+ï¼‰ï¼š</b><span style="font-size:.82em">${strong.map(t=>CAPITAL_TRAITS[t].icon+CAPITAL_TRAITS[t].name).join('ã€')}</span></div>`;
    if (mid.length) mapHtml += `<div style="margin-bottom:6px"><b style="color:var(--text-muted);font-size:.82em">æ™®é€šï¼ˆ2.5ã€œ3.4ï¼‰ï¼š</b><span style="font-size:.82em">${mid.map(t=>CAPITAL_TRAITS[t].icon+CAPITAL_TRAITS[t].name).join('ã€')}</span></div>`;
    if (weak.length) mapHtml += `<div style="margin-bottom:6px"><b style="color:var(--danger);font-size:.82em">è¦å¼·åŒ–ï¼ˆã€œ2.4ï¼‰ï¼š</b><span style="font-size:.82em">${weak.map(t=>CAPITAL_TRAITS[t].icon+CAPITAL_TRAITS[t].name).join('ã€')}</span></div>`;
    if (strong.length >= 2) {
      mapHtml += `<div style="margin-top:10px;padding:10px;background:var(--success-bg);border-radius:10px;font-size:.8em;color:#166534"><b>æ´»ç”¨å¯èƒ½ãªçµ„ã¿åˆã‚ã›ï¼š</b> ${strong.map(t=>CAPITAL_TRAITS[t].name).join(' Ã— ')} â†’ ã“ã‚Œã‚‰ã‚’æ›ã‘åˆã‚ã›ã¦ç›®æ¨™é”æˆã«æ´»ã‹ã›ã‚‹</div>`;
    } else if (strong.length === 1) {
      mapHtml += `<div style="margin-top:10px;padding:10px;background:#fffbeb;border-radius:10px;font-size:.8em;color:#92400e"><b>æƒœã—ã„ï¼š</b> ${CAPITAL_TRAITS[strong[0]].name}ã¯å¼·ã„ãŒã€ã‚‚ã†1ã¤è³‡æœ¬ã‚’ä¼¸ã°ã›ã‚‹ã¨å¤§ããå¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚ã‚Š</div>`;
    } else {
      mapHtml += `<div style="margin-top:10px;padding:10px;background:var(--danger-bg);border-radius:10px;font-size:.8em;color:#991b1b"><b>èª²é¡Œï¼š</b> çªå‡ºã—ãŸè³‡æœ¬ãŒã¾ã ãªã„ã€‚ã¾ãš1ã¤ã®è³‡æœ¬ã‚’é›†ä¸­çš„ã«è‚²ã¦ã‚‹ã“ã¨ãŒå…ˆæ±º</div>`;
    }
    mapHtml += `</div>`;
    c.innerHTML += mapHtml;
    CAPITAL_ORDER.forEach(t => { c.innerHTML += renderCapitalCard(scores.capital[t], CAPITAL_TRAITS[t]); });
  }

  // Summary
  c.innerHTML += renderCombinedSummary(scores, name);
}

// ---- Render helpers ----
function renderBFCard(s, tr) {
  const pct = s.avg/5*100, pctR = s.avgR/5*100;
  return `<div class="trait-card">
    <div class="trait-title-row">
      <span class="trait-name" style="color:${tr.color}">${tr.name}ï¼ˆ${tr.en}ï¼‰</span>
      <span class="trait-badge" style="background:${tr.bg};color:${tr.color}">${s.avg.toFixed(2)}</span>
    </div>
    <div class="bar-row"><div class="bar-label" style="color:${tr.color}">${tr.name}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${tr.color}">${s.avg.toFixed(2)}</div></div><div class="bar-value" style="color:${tr.color}">${pct.toFixed(0)}%</div></div>
    <div class="bar-row"><div class="bar-label" style="color:${tr.colorLow}">${tr.low}</div><div class="bar-track"><div class="bar-fill" style="width:${pctR}%;background:${tr.colorLow}">${s.avgR.toFixed(2)}</div></div><div class="bar-value" style="color:${tr.colorLow}">${pctR.toFixed(0)}%</div></div>
    <div class="spectrum"><span class="spectrum-label" style="color:${tr.colorLow}">${tr.low}</span><div class="spectrum-track" style="background:linear-gradient(90deg,${tr.colorLow}33,${tr.color}33)"><div class="spectrum-marker" style="left:${pct}%;background:${tr.color}"></div></div><span class="spectrum-label" style="color:${tr.color}">${tr.name}</span></div>
    <div class="facets-info"><b>é«˜ï¼š</b>${tr.facets.high.join('ã€')}<br><b>ä½ï¼š</b>${tr.facets.low.join('ã€')}</div>
    <div class="calc-toggle" onclick="toggleCalc(this)">â–¶ è¨ˆç®—ã®å†…è¨³</div>
    <div class="calc-detail">
      ${s.items.map(it => `<div class="calc-row ${it.r?'reverse':''}"><span>${it.text.substring(0,22)}â€¦</span><span class="calc-formula">${it.r?it.raw+'â†’(6-'+it.raw+')=<b>'+it.eff+'</b>':it.raw+'â†’<b>'+it.eff+'</b>'}</span></div>`).join('')}
      <div class="calc-row total"><span>åˆè¨ˆ</span><span>${s.items.map(it=>it.eff).join('+')}=${s.total}</span></div>
      <div class="calc-row total"><span>å¹³å‡</span><span>${s.total}Ã·${s.items.length}=<b>${s.avg.toFixed(2)}</b></span></div>
      <div class="calc-row total"><span>é€†ä½ç›¸</span><span>6-${s.avg.toFixed(2)}=<b>${s.avgR.toFixed(2)}</b></span></div>
    </div>
  </div>`;
}

function renderDarkCard(s, tr) {
  const pct = s.avg/5*100;
  return `<div class="trait-card">
    <div class="trait-title-row">
      <span class="trait-name" style="color:${tr.color}">${tr.name}ï¼ˆ${tr.en}ï¼‰</span>
      <span class="trait-badge" style="background:${tr.bg};color:${tr.color}">${s.avg.toFixed(2)}</span>
    </div>
    <div class="bar-row"><div class="bar-label" style="color:${tr.color}">ã‚¹ã‚³ã‚¢</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${tr.color}">${s.avg.toFixed(2)}</div></div><div class="bar-value">${pct.toFixed(0)}%</div></div>
    <div class="interp">
      <div class="biz"><b>ãƒ“ã‚¸ãƒã‚¹é¢</b>${tr.biz}</div>
      <div class="shadow"><b>ã‚·ãƒ£ãƒ‰ã‚¦é¢</b>${tr.shadow}</div>
    </div>
    <div class="calc-toggle" onclick="toggleCalc(this)">â–¶ å†…è¨³</div>
    <div class="calc-detail">
      ${s.items.map(it => `<div class="calc-row"><span>${it.text.substring(0,22)}â€¦</span><span class="calc-formula">${it.raw}</span></div>`).join('')}
      <div class="calc-row total"><span>å¹³å‡</span><span>${s.total}Ã·${s.items.length}=<b>${s.avg.toFixed(2)}</b></span></div>
    </div>
  </div>`;
}

function renderTypeCard(s, tr, isPrimary) {
  const pct = s.avg/5*100;
  return `<div class="trait-card" style="${isPrimary?'border:2px solid '+tr.color:''}">
    <div class="trait-title-row">
      <span class="trait-name" style="color:${tr.color}">${tr.name}${isPrimary?' â˜…':''}</span>
      <span class="trait-badge" style="background:${tr.bg};color:${tr.color}">${s.avg.toFixed(2)}</span>
    </div>
    <div class="bar-row"><div class="bar-label" style="color:${tr.color}">ã‚¹ã‚³ã‚¢</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${tr.color}">${s.avg.toFixed(2)}</div></div><div class="bar-value">${pct.toFixed(0)}%</div></div>
  </div>`;
}

function renderEntreCard(s, tr) {
  const pct = s.avg/5*100;
  return `<div class="trait-card">
    <div class="trait-title-row">
      <span class="trait-name" style="color:${tr.color}">${tr.name}</span>
      <span class="trait-badge" style="background:${tr.bg};color:${tr.color}">${s.avg.toFixed(2)}</span>
    </div>
    <div class="bar-row"><div class="bar-label" style="color:${tr.color}">ã‚¹ã‚³ã‚¢</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${tr.color}">${s.avg.toFixed(2)}</div></div><div class="bar-value">${pct.toFixed(0)}%</div></div>
    <div class="calc-toggle" onclick="toggleCalc(this)">â–¶ å†…è¨³</div>
    <div class="calc-detail">
      ${s.items.map(it => `<div class="calc-row ${it.r?'reverse':''}"><span>${it.text.substring(0,22)}â€¦</span><span class="calc-formula">${it.r?it.raw+'â†’(6-'+it.raw+')=<b>'+it.eff+'</b>':it.raw+'â†’<b>'+it.eff+'</b>'}</span></div>`).join('')}
      <div class="calc-row total"><span>å¹³å‡</span><span>${s.total}Ã·${s.items.length}=<b>${s.avg.toFixed(2)}</b></span></div>
    </div>
  </div>`;
}

function renderCapitalCard(s, tr) {
  const pct = s.avg/5*100;
  const level = s.avg >= 4 ? 'éå¸¸ã«è±Šã‹' : s.avg >= 3.5 ? 'è±Šã‹' : s.avg >= 2.5 ? 'æ™®é€š' : s.avg >= 1.5 ? 'ä¸è¶³æ°—å‘³' : 'è¦å¼·åŒ–';
  const levelColor = s.avg >= 3.5 ? 'var(--success)' : s.avg >= 2.5 ? 'var(--text-muted)' : 'var(--danger)';
  return `<div class="trait-card">
    <div class="trait-title-row">
      <span class="trait-name" style="color:${tr.color}">${tr.icon} ${tr.name}ï¼ˆ${tr.en}ï¼‰</span>
      <span class="trait-badge" style="background:${tr.bg};color:${tr.color}">${s.avg.toFixed(2)}</span>
    </div>
    <div style="font-size:.72em;color:var(--text-muted);margin-bottom:8px">${tr.desc}</div>
    <div class="bar-row"><div class="bar-label" style="color:${tr.color}">ã‚¹ã‚³ã‚¢</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${tr.color}">${s.avg.toFixed(2)}</div></div><div class="bar-value" style="color:${levelColor};font-size:.68em">${level}</div></div>
    <div class="calc-toggle" onclick="toggleCalc(this)">â–¶ å†…è¨³</div>
    <div class="calc-detail">
      ${s.items.map(it => `<div class="calc-row ${it.r?'reverse':''}"><span>${it.text.substring(0,22)}â€¦</span><span class="calc-formula">${it.r?it.raw+'â†’(6-'+it.raw+')=<b>'+it.eff+'</b>':it.raw+'â†’<b>'+it.eff+'</b>'}</span></div>`).join('')}
      <div class="calc-row total"><span>å¹³å‡</span><span>${s.total}Ã·${s.items.length}=<b>${s.avg.toFixed(2)}</b></span></div>
    </div>
  </div>`;
}

function renderCombinedSummary(scores, name) {
  const lines = [`<b>${name}</b> ã®ç·åˆäºˆæ¸¬ï¼š<br>`];

  if (scores.bigfive) {
    let maxT='E',minT='E';
    BF_ORDER.forEach(t => {
      if(scores.bigfive[t].avg>scores.bigfive[maxT].avg) maxT=t;
      if(scores.bigfive[t].avg<scores.bigfive[minT].avg) minT=t;
    });
    lines.push(`<b>æ€§æ ¼ã®è»¸ï¼š</b> ${BF_TRAITS[maxT].name}ãŒæœ€ã‚‚é«˜ãï¼ˆ${scores.bigfive[maxT].avg.toFixed(2)}ï¼‰ã€${BF_TRAITS[minT].name}ãŒæœ€ã‚‚ä½ã„ï¼ˆ${scores.bigfive[minT].avg.toFixed(2)}ï¼‰`);
  }
  if (scores.dark) {
    const sorted = [...DARK_ORDER].sort((a,b) => scores.dark[b].avg - scores.dark[a].avg);
    if (scores.dark[sorted[0]].avg >= 3.5) {
      lines.push(`<b>æ³¨æ„ç‚¹ï¼š</b> ${DARK_TRAITS[sorted[0]].name}ãŒé«˜ã‚ï¼ˆ${scores.dark[sorted[0]].avg.toFixed(2)}ï¼‰â€” ${DARK_TRAITS[sorted[0]].shadow}`);
    }
  }
  if (scores.types) {
    const sorted = [...TYPE_ORDER].sort((a,b) => scores.types[b].avg - scores.types[a].avg);
    lines.push(`<b>æ¥ã—æ–¹ï¼š</b> ${TYPE_TRAITS[sorted[0]].name}ã‚¿ã‚¤ãƒ— â†’ ${TYPE_TRAITS[sorted[0]].comm}`);
  }
  if (scores.entre) {
    const entreAvg = ENTRE_ORDER.reduce((a,t) => a + scores.entre[t].avg, 0) / 4;
    const maxE = ENTRE_ORDER.reduce((a,b) => scores.entre[a].avg > scores.entre[b].avg ? a : b);
    const minE = ENTRE_ORDER.reduce((a,b) => scores.entre[a].avg < scores.entre[b].avg ? a : b);
    lines.push(`<b>èµ·æ¥­å®¶é©æ€§ï¼š</b> ç·åˆ ${entreAvg.toFixed(2)} â€” å¼·ã¿: ${ENTRE_TRAITS[maxE].name}ã€èª²é¡Œ: ${ENTRE_TRAITS[minE].name}`);
  }
  if (scores.capital) {
    const strong = CAPITAL_ORDER.filter(t => scores.capital[t].avg >= 3.5);
    const maxC = CAPITAL_ORDER.reduce((a,b) => scores.capital[a].avg > scores.capital[b].avg ? a : b);
    const minC = CAPITAL_ORDER.reduce((a,b) => scores.capital[a].avg < scores.capital[b].avg ? a : b);
    lines.push(`<b>ãƒªã‚½ãƒ¼ã‚¹ï¼š</b> æœ€å¼·ã¯${CAPITAL_TRAITS[maxC].icon}${CAPITAL_TRAITS[maxC].name}ï¼ˆ${scores.capital[maxC].avg.toFixed(2)}ï¼‰ã€è¦å¼·åŒ–ã¯${CAPITAL_TRAITS[minC].icon}${CAPITAL_TRAITS[minC].name}ï¼ˆ${scores.capital[minC].avg.toFixed(2)}ï¼‰`);
    if (strong.length >= 2) {
      lines.push(`<b>çµ„ã¿åˆã‚ã›ï¼š</b> ${strong.map(t=>CAPITAL_TRAITS[t].name).join('Ã—')} ã§ç›®æ¨™é”æˆã®ãƒªã‚½ãƒ¼ã‚¹ã‚ã‚Š`);
    }
  }

  return `<div class="summary-card"><h3>ç·åˆåˆ†æ</h3><div class="summary-text">${lines.join('<br>')}</div></div>`;
}

function toggleCalc(el) {
  const d = el.nextElementSibling;
  d.classList.toggle('show');
  el.textContent = d.classList.contains('show') ? 'â–¼ éš ã™' : 'â–¶ è¨ˆç®—ã®å†…è¨³';
}

// ============================================================
// RADAR CHART (Big Five)
// ============================================================
function drawRadar(bfScores, canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const dpr = window.devicePixelRatio || 1;
  const cssSize = Math.min(340, window.innerWidth - 50);
  canvas.style.width = cssSize+'px'; canvas.style.height = cssSize+'px';
  canvas.width = cssSize*dpr; canvas.height = cssSize*dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr); ctx.clearRect(0,0,cssSize,cssSize);
  const cx=cssSize/2, cy=cssSize/2, radius=cssSize*.35, n=5;
  const vals = BF_ORDER.map(t => bfScores[t].avg/5);
  const valsR = BF_ORDER.map(t => bfScores[t].avgR/5);
  const labels = BF_ORDER.map(t => BF_TRAITS[t].name);

  for(let lv=1;lv<=5;lv++){ctx.beginPath();for(let i=0;i<=n;i++){const a=(Math.PI*2/n)*i-Math.PI/2,r=radius*lv/5;i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a))}ctx.strokeStyle='#ddd';ctx.lineWidth=1;ctx.stroke()}
  for(let i=0;i<n;i++){const a=(Math.PI*2/n)*i-Math.PI/2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+radius*Math.cos(a),cy+radius*Math.sin(a));ctx.strokeStyle='#ddd';ctx.stroke()}
  ctx.fillStyle='#555';ctx.font=`${Math.max(10,cssSize*.034)}px sans-serif`;ctx.textAlign='center';
  for(let i=0;i<n;i++){const a=(Math.PI*2/n)*i-Math.PI/2;ctx.fillText(labels[i],cx+(radius+20)*Math.cos(a),cy+(radius+20)*Math.sin(a)+4)}

  // Reverse
  ctx.beginPath();for(let i=0;i<=n;i++){const idx=i%n,a=(Math.PI*2/n)*idx-Math.PI/2,x=cx+radius*valsR[idx]*Math.cos(a),y=cy+radius*valsR[idx]*Math.sin(a);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}ctx.fillStyle='rgba(231,76,60,.08)';ctx.fill();ctx.strokeStyle='#e74c3c';ctx.lineWidth=1.5;ctx.stroke();
  // Main
  ctx.beginPath();for(let i=0;i<=n;i++){const idx=i%n,a=(Math.PI*2/n)*idx-Math.PI/2,x=cx+radius*vals[idx]*Math.cos(a),y=cy+radius*vals[idx]*Math.sin(a);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}ctx.fillStyle='rgba(91,106,191,.15)';ctx.fill();ctx.strokeStyle='#5b6abf';ctx.lineWidth=2;ctx.stroke();
  // Dots
  for(let i=0;i<n;i++){const a=(Math.PI*2/n)*i-Math.PI/2;ctx.beginPath();ctx.arc(cx+radius*vals[i]*Math.cos(a),cy+radius*vals[i]*Math.sin(a),4,0,Math.PI*2);ctx.fillStyle='#5b6abf';ctx.fill();ctx.beginPath();ctx.arc(cx+radius*valsR[i]*Math.cos(a),cy+radius*valsR[i]*Math.sin(a),3,0,Math.PI*2);ctx.fillStyle='#e74c3c';ctx.fill()}
}

// ============================================================
// SAVE / LOAD
// ============================================================
function getSaved() { try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]} }
function setSaved(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); updateBadge(); }
function updateBadge() { const b=document.getElementById('listBadge'),c=getSaved().length; b.style.display=c>0?'':'none'; b.textContent=c; }

function saveResult() {
  const name = lastTargetName;
  const entry = {
    id: Date.now().toString(36)+Math.random().toString(36).substr(2,4),
    name, date: new Date().toISOString(),
    modules: [...activeModules],
    answers: {...answers},
    scoresCache: {}
  };
  // Cache averages for list display
  if (lastScores.bigfive) { entry.scoresCache.bigfive = {}; BF_ORDER.forEach(t => { entry.scoresCache.bigfive[t] = lastScores.bigfive[t].avg; }); }
  if (lastScores.dark) { entry.scoresCache.dark = {}; DARK_ORDER.forEach(t => { entry.scoresCache.dark[t] = lastScores.dark[t].avg; }); }
  if (lastScores.types) { entry.scoresCache.types = {}; TYPE_ORDER.forEach(t => { entry.scoresCache.types[t] = lastScores.types[t].avg; }); }
  if (lastScores.entre) { entry.scoresCache.entre = {}; ENTRE_ORDER.forEach(t => { entry.scoresCache.entre[t] = lastScores.entre[t].avg; }); }
  if (lastScores.capital) { entry.scoresCache.capital = {}; CAPITAL_ORDER.forEach(t => { entry.scoresCache.capital[t] = lastScores.capital[t].avg; }); }

  const saved = getSaved(); saved.unshift(entry); setSaved(saved);
  alert(`${name} ã®çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
  autoSyncToDrive();
}

function deleteResult(id) { if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return; setSaved(getSaved().filter(e=>e.id!==id)); renderList(); }

function renderList() {
  const c = document.getElementById('listContent'), saved = getSaved();
  updateBadge();
  if (!saved.length) { c.innerHTML = `<div class="list-empty"><p style="font-size:2em;margin-bottom:10px">ğŸ“‹</p><p>ä¿å­˜ã•ã‚ŒãŸçµæœã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p><p style="font-size:.78em;margin-top:4px">è¨ºæ–­ã‚’å®Œäº†ã—ã¦ã€Œä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p></div>`; return; }

  // Group by person name
  const groups = {};
  saved.forEach(entry => {
    const key = entry.name.trim().toLowerCase();
    if (!groups[key]) groups[key] = {name: entry.name, entries: []};
    groups[key].entries.push(entry);
  });

  // Sort groups by latest entry date
  const sortedGroups = Object.values(groups).sort((a,b) =>
    new Date(b.entries[0].date) - new Date(a.entries[0].date)
  );

  c.innerHTML = sortedGroups.map(group => {
    const entries = group.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
    const hasMultiple = entries.length >= 2;
    const entryRows = entries.map(entry => {
      const d = new Date(entry.date);
      const ds = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
      let badges = '';
      if (entry.scoresCache.bigfive) { BF_ORDER.slice(0,3).forEach(t => { badges += `<span class="mini-score" style="background:${BF_TRAITS[t].bg};color:${BF_TRAITS[t].color}">${BF_TRAITS[t].name}${entry.scoresCache.bigfive[t].toFixed(1)}</span>`; }); }
      if (entry.scoresCache.types) {
        const sorted = [...TYPE_ORDER].sort((a,b) => entry.scoresCache.types[b] - entry.scoresCache.types[a]);
        badges += `<span class="mini-score" style="background:${TYPE_TRAITS[sorted[0]].bg};color:${TYPE_TRAITS[sorted[0]].color}">${TYPE_TRAITS[sorted[0]].name}</span>`;
      }
      if (entry.scoresCache.capital) {
        const strong = CAPITAL_ORDER.filter(t => (entry.scoresCache.capital[t]||0) >= 3.5);
        if (strong.length) badges += `<span class="mini-score" style="background:#ecfdf5;color:#059669">${strong.map(t=>CAPITAL_TRAITS[t].icon).join('')}${strong.length}è³‡æœ¬</span>`;
      }
      return `<div class="person-entry" onclick="showDetail('${entry.id}')">
        <span class="date">${ds}</span>
        <span class="scores">${badges}</span>
        <span class="del-btn" onclick="event.stopPropagation();deleteResult('${entry.id}')">å‰Šé™¤</span>
      </div>`;
    }).join('');

    const timelineBtn = hasMultiple
      ? `<button class="timeline-btn" onclick="event.stopPropagation();showTimeline('${escHtml(group.name)}')">æ™‚ç³»åˆ—å¤‰åŒ–ã‚’è¦‹ã‚‹ï¼ˆ${entries.length}å›åˆ†ï¼‰</button>`
      : '';
    const chatBtn = `<button class="timeline-btn" style="background:#ecfdf5;color:#059669;border-top:1px solid var(--border)" onclick="event.stopPropagation();openChat('${escHtml(group.name)}')">ç·åˆAIåˆ†æãƒ»ãƒãƒ£ãƒƒãƒˆ</button>`;

    return `<div class="person-group">
      <div class="person-header">
        <span class="name">${escHtml(group.name)}</span>
        <span class="count">${entries.length}å›è¨˜éŒ²</span>
      </div>
      <div class="person-entries">${entryRows}${timelineBtn}${chatBtn}</div>
    </div>`;
  }).join('');
}

// ============================================================
// TIMELINE VIEW
// ============================================================
function showTimeline(name) {
  const saved = getSaved().filter(e => e.name.trim().toLowerCase() === name.trim().toLowerCase());
  if (saved.length < 2) return;

  const sorted = [...saved].sort((a,b) => new Date(a.date) - new Date(b.date));
  const c = document.getElementById('timelineContent');

  c.innerHTML = `<div class="result-header"><h2>${escHtml(name)} ã®æ™‚ç³»åˆ—å¤‰åŒ–</h2><div class="date">${sorted.length}å›ã®è¨˜éŒ²</div></div>`;

  // Big Five timeline
  if (sorted[0].scoresCache.bigfive) {
    c.innerHTML += `<div class="timeline-section"><h3>ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–ã®å¤‰åŒ–</h3><div class="sub">æ—¥ä»˜ã”ã¨ã®ã‚¹ã‚³ã‚¢æ¨ç§»</div><canvas id="tl_bf" width="360" height="220"></canvas>
      <div class="timeline-legend">${BF_ORDER.map(t => `<span><span class="dot" style="background:${BF_TRAITS[t].color}"></span>${BF_TRAITS[t].name}</span>`).join('')}</div></div>`;
    c.innerHTML += renderChangeTable(sorted, 'bigfive', BF_ORDER, BF_TRAITS);
  }

  // Dark Triad timeline
  if (sorted[0].scoresCache.dark) {
    c.innerHTML += `<div class="timeline-section"><h3>ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰ã®å¤‰åŒ–</h3><canvas id="tl_dark" width="360" height="200"></canvas>
      <div class="timeline-legend">${DARK_ORDER.map(t => `<span><span class="dot" style="background:${DARK_TRAITS[t].color}"></span>${DARK_TRAITS[t].name}</span>`).join('')}</div></div>`;
    c.innerHTML += renderChangeTable(sorted, 'dark', DARK_ORDER, DARK_TRAITS);
  }

  // 4 Types timeline
  if (sorted[0].scoresCache.types) {
    c.innerHTML += `<div class="timeline-section"><h3>4ã‚¿ã‚¤ãƒ—ã®å¤‰åŒ–</h3><canvas id="tl_types" width="360" height="200"></canvas>
      <div class="timeline-legend">${TYPE_ORDER.map(t => `<span><span class="dot" style="background:${TYPE_TRAITS[t].color}"></span>${TYPE_TRAITS[t].name}</span>`).join('')}</div></div>`;
  }

  // Entrepreneurial timeline
  if (sorted[0].scoresCache.entre) {
    c.innerHTML += `<div class="timeline-section"><h3>èµ·æ¥­å®¶é©æ€§ã®å¤‰åŒ–</h3><canvas id="tl_entre" width="360" height="200"></canvas>
      <div class="timeline-legend">${ENTRE_ORDER.map(t => `<span><span class="dot" style="background:${ENTRE_TRAITS[t].color}"></span>${ENTRE_TRAITS[t].name}</span>`).join('')}</div></div>`;
    c.innerHTML += renderChangeTable(sorted, 'entre', ENTRE_ORDER, ENTRE_TRAITS);
  }

  // Capital timeline
  if (sorted[0].scoresCache.capital) {
    c.innerHTML += `<div class="timeline-section"><h3>è³‡æœ¬è«–ã®å¤‰åŒ–</h3><div class="sub">6ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ã®æ¨ç§»</div><canvas id="tl_capital" width="360" height="220"></canvas>
      <div class="timeline-legend">${CAPITAL_ORDER.map(t => `<span><span class="dot" style="background:${CAPITAL_TRAITS[t].color}"></span>${CAPITAL_TRAITS[t].icon}${CAPITAL_TRAITS[t].name}</span>`).join('')}</div></div>`;
    c.innerHTML += renderChangeTable(sorted, 'capital', CAPITAL_ORDER, CAPITAL_TRAITS);
  }

  switchTab('timeline');
  setTimeout(() => {
    if (sorted[0].scoresCache.bigfive) drawTimeline(sorted, 'bigfive', BF_ORDER, BF_TRAITS, 'tl_bf');
    if (sorted[0].scoresCache.dark) drawTimeline(sorted, 'dark', DARK_ORDER, DARK_TRAITS, 'tl_dark');
    if (sorted[0].scoresCache.types) drawTimeline(sorted, 'types', TYPE_ORDER, TYPE_TRAITS, 'tl_types');
    if (sorted[0].scoresCache.entre) drawTimeline(sorted, 'entre', ENTRE_ORDER, ENTRE_TRAITS, 'tl_entre');
    if (sorted[0].scoresCache.capital) drawTimeline(sorted, 'capital', CAPITAL_ORDER, CAPITAL_TRAITS, 'tl_capital');
  }, 80);
}

function renderChangeTable(sorted, module, order, traitDefs) {
  if (sorted.length < 2) return '';
  const first = sorted[0].scoresCache[module];
  const last = sorted[sorted.length-1].scoresCache[module];
  const firstDate = new Date(sorted[0].date);
  const lastDate = new Date(sorted[sorted.length-1].date);
  const days = Math.round((lastDate - firstDate) / 86400000);

  let rows = order.map(t => {
    const diff = last[t] - first[t];
    const cls = diff > 0.2 ? 'change-up' : diff < -0.2 ? 'change-down' : 'change-flat';
    const arrow = diff > 0.2 ? '+' : diff < -0.2 ? '' : 'Â±';
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border);font-size:.8em">
      <span style="color:${traitDefs[t].color};font-weight:600">${traitDefs[t].name}</span>
      <span>${first[t].toFixed(2)} â†’ ${last[t].toFixed(2)} <span class="change-indicator ${cls}">${arrow}${diff.toFixed(2)}</span></span>
    </div>`;
  }).join('');

  return `<div class="card"><div style="font-size:.78em;color:var(--text-muted);margin-bottom:6px">${days}æ—¥é–“ã®å¤‰åŒ–ï¼ˆåˆå›â†’æœ€æ–°ï¼‰</div>${rows}</div>`;
}

function drawTimeline(entries, module, order, traitDefs, canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const dpr = window.devicePixelRatio || 1;
  const cssW = Math.min(360, window.innerWidth - 50);
  const cssH = module === 'bigfive' ? 220 : 200;
  canvas.style.width = cssW+'px'; canvas.style.height = cssH+'px';
  canvas.width = cssW*dpr; canvas.height = cssH*dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,cssW,cssH);

  const pad = {top:15, right:15, bottom:35, left:35};
  const w = cssW - pad.left - pad.right;
  const h = cssH - pad.top - pad.bottom;
  const n = entries.length;

  // Y axis (1-5)
  ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
  ctx.fillStyle = '#aaa'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
  for (let v = 1; v <= 5; v++) {
    const y = pad.top + h - (v-1)/(5-1)*h;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left+w, y); ctx.stroke();
    ctx.fillText(v, pad.left-5, y+3);
  }

  // X axis labels
  ctx.textAlign = 'center'; ctx.fillStyle = '#888'; ctx.font = '9px sans-serif';
  entries.forEach((entry, i) => {
    const x = n===1 ? pad.left+w/2 : pad.left + i/(n-1)*w;
    const d = new Date(entry.date);
    const label = `${d.getMonth()+1}/${d.getDate()}`;
    ctx.fillText(label, x, cssH - 5);
  });

  // Draw lines
  order.forEach(t => {
    ctx.beginPath();
    ctx.strokeStyle = traitDefs[t].color;
    ctx.lineWidth = 2;
    entries.forEach((entry, i) => {
      const x = n===1 ? pad.left+w/2 : pad.left + i/(n-1)*w;
      const val = entry.scoresCache[module][t];
      const y = pad.top + h - (val-1)/(5-1)*h;
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Dots
    entries.forEach((entry, i) => {
      const x = n===1 ? pad.left+w/2 : pad.left + i/(n-1)*w;
      const val = entry.scoresCache[module][t];
      const y = pad.top + h - (val-1)/(5-1)*h;
      ctx.beginPath(); ctx.arc(x,y,3.5,0,Math.PI*2);
      ctx.fillStyle = traitDefs[t].color; ctx.fill();
    });
  });
}

// ============================================================
// EXPORT / IMPORT
// ============================================================
function exportJSON() {
  const saved = getSaved();
  if (!saved.length) { alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const blob = new Blob([JSON.stringify(saved, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `personality-observer-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('Invalid format');
      const existing = getSaved();
      const existingIds = new Set(existing.map(e => e.id));
      let added = 0;
      data.forEach(entry => {
        if (entry.id && entry.name && entry.date && !existingIds.has(entry.id)) {
          existing.push(entry);
          added++;
        }
      });
      existing.sort((a,b) => new Date(b.date) - new Date(a.date));
      setSaved(existing);
      renderList();
      alert(`${added}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆé‡è¤‡ã¯é™¤å¤–ï¼‰`);
    } catch(err) {
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// ============================================================
// GOOGLE DRIVE SYNC
// ============================================================
const GAS_URL_KEY = 'personality_observer_gas_url';

function getGasUrl() { return localStorage.getItem(GAS_URL_KEY) || ''; }

function saveGasUrl() {
  const url = document.getElementById('gasUrlInput').value.trim();
  if (!url) { localStorage.removeItem(GAS_URL_KEY); updateDriveUI(); return; }
  localStorage.setItem(GAS_URL_KEY, url);
  updateDriveUI();
  setDriveStatus('URLä¿å­˜ã—ã¾ã—ãŸ', 'var(--success)');
}

function updateDriveUI() {
  const url = getGasUrl();
  const section = document.getElementById('driveSection');
  const status = document.getElementById('driveStatus');
  if (url) {
    section.classList.add('connected');
    status.textContent = 'æ¥ç¶šæ¸ˆã¿';
    status.className = 'status on';
  } else {
    section.classList.remove('connected');
    status.textContent = 'æœªæ¥ç¶š';
    status.className = 'status off';
  }
}

function toggleDrivePanel() {
  document.getElementById('driveBody').classList.toggle('open');
}

function setDriveStatus(msg, color) {
  const el = document.getElementById('driveSyncStatus');
  el.textContent = msg;
  el.style.color = color || 'var(--text-muted)';
  if (msg) setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 5000);
}

async function syncToDrive() {
  const url = getGasUrl();
  if (!url) { setDriveStatus('GAS URLãŒæœªè¨­å®šã§ã™', 'var(--danger)'); return; }
  const saved = getSaved();
  setDriveStatus('Driveã«ä¿å­˜ä¸­...', 'var(--text-muted)');
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ data: saved }),
      mode: 'no-cors'
    });
    // GAS web apps with no-cors return opaque response, so we can't read body
    // Use redirect-based approach instead
    setDriveStatus('é€ä¿¡å®Œäº†ï¼ˆDriveã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼‰', 'var(--success)');
  } catch (err) {
    setDriveStatus('ä¿å­˜å¤±æ•—: ' + err.message, 'var(--danger)');
  }
}

async function loadFromDrive() {
  const url = getGasUrl();
  if (!url) { setDriveStatus('GAS URLãŒæœªè¨­å®šã§ã™', 'var(--danger)'); return; }
  setDriveStatus('Driveã‹ã‚‰èª­è¾¼ä¸­...', 'var(--text-muted)');
  try {
    const res = await fetch(url);
    const json = await res.json();
    if (!json.success) { setDriveStatus('èª­è¾¼å¤±æ•—: ' + (json.error||'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'var(--danger)'); return; }
    const driveData = json.data || [];
    if (!driveData.length) { setDriveStatus('Driveã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'var(--text-muted)'); return; }
    // Merge: add entries not already in local
    const local = getSaved();
    const localIds = new Set(local.map(e => e.id));
    let added = 0;
    driveData.forEach(entry => {
      if (entry.id && !localIds.has(entry.id)) { local.push(entry); added++; }
    });
    local.sort((a,b) => new Date(b.date) - new Date(a.date));
    setSaved(local);
    renderList();
    setDriveStatus(`èª­è¾¼å®Œäº†ï¼ˆ${added}ä»¶è¿½åŠ ã€${driveData.length}ä»¶ä¸­ï¼‰`, 'var(--success)');
  } catch (err) {
    setDriveStatus('èª­è¾¼å¤±æ•—: ' + err.message, 'var(--danger)');
  }
}

async function autoSyncToDrive() {
  const url = getGasUrl();
  if (!url) return;
  try {
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ data: getSaved() }),
      mode: 'no-cors'
    });
  } catch(e) { /* silent fail for auto-sync */ }
}

function showDetail(id) {
  const entry = getSaved().find(e => e.id === id);
  if (!entry) return;
  // Reconstruct state
  activeModules = entry.modules;
  allQuestions = [];
  activeModules.forEach(mid => { QUESTIONS[mid].forEach((q,i) => { allQuestions.push({...q, module:mid, originalIndex:i}); }); });
  const scores = calcAllScores(entry.answers);
  const c = document.getElementById('detailContent');
  const d = new Date(entry.date);
  const ds = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
  c.innerHTML = `<div class="result-header"><h2>${escHtml(entry.name)} ã®äºˆæ¸¬çµæœ</h2><div class="date">${ds}</div></div><div id="detailResults"></div>`;
  switchTab('detail');
  setTimeout(() => renderAllResults(scores, entry.name, 'detailResults'), 50);
}

// ============================================================
// AI ANALYSIS
// ============================================================
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (key) { localStorage.setItem('anthropic_api_key', key); alert('ä¿å­˜ã—ã¾ã—ãŸ'); }
}

function goToAI() {
  document.getElementById('includeScores').checked = true;
  switchTab('ai');
}

function setAIPrompt(text) {
  const ta = document.getElementById('aiInput');
  ta.value = (ta.value ? ta.value + '\n\n' : '') + text;
  ta.focus();
}

async function runAI() {
  const apiKey = localStorage.getItem('anthropic_api_key');
  if (!apiKey) { alert('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
  const input = document.getElementById('aiInput').value.trim();
  if (!input) { alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const model = document.getElementById('modelSelect').value;
  const includeScores = document.getElementById('includeScores').checked;

  let context = '';
  if (includeScores && lastScores) {
    context = `\n\nã€è¨ºæ–­çµæœãƒ‡ãƒ¼ã‚¿ã€‘\nå¯¾è±¡è€…: ${lastTargetName}\n`;
    if (lastScores.bigfive) {
      context += '\nãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–:\n';
      BF_ORDER.forEach(t => { const s=lastScores.bigfive[t]; context += `  ${BF_TRAITS[t].name}: ${s.avg.toFixed(2)} / ${BF_TRAITS[t].low}: ${s.avgR.toFixed(2)}\n`; });
    }
    if (lastScores.dark) {
      context += '\nãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰:\n';
      DARK_ORDER.forEach(t => { context += `  ${DARK_TRAITS[t].name}: ${lastScores.dark[t].avg.toFixed(2)}\n`; });
    }
    if (lastScores.types) {
      context += '\n4ã‚¿ã‚¤ãƒ—:\n';
      TYPE_ORDER.forEach(t => { context += `  ${TYPE_TRAITS[t].name}: ${lastScores.types[t].avg.toFixed(2)}\n`; });
    }
    if (lastScores.entre) {
      context += '\nèµ·æ¥­å®¶é©æ€§:\n';
      ENTRE_ORDER.forEach(t => { context += `  ${ENTRE_TRAITS[t].name}: ${lastScores.entre[t].avg.toFixed(2)}\n`; });
    }
    if (lastScores.capital) {
      context += '\nè³‡æœ¬è«–ï¼ˆ6ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ï¼‰:\n';
      CAPITAL_ORDER.forEach(t => { context += `  ${CAPITAL_TRAITS[t].icon}${CAPITAL_TRAITS[t].name}: ${lastScores.capital[t].avg.toFixed(2)}\n`; });
      const strong = CAPITAL_ORDER.filter(t => lastScores.capital[t].avg >= 3.5);
      if (strong.length >= 2) context += `  â†’ çµ„ã¿åˆã‚ã›å¯èƒ½: ${strong.map(t=>CAPITAL_TRAITS[t].name).join('Ã—')}\n`;
    }
  }

  const systemPrompt = `ã‚ãªãŸã¯æ€§æ ¼åˆ†æãƒ»ã‚³ãƒ¼ãƒãƒ³ã‚°ã®å°‚é–€å®¶ã§ã™ã€‚ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–ã€ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³4ã‚¿ã‚¤ãƒ—ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼/ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼/ã‚µãƒãƒ¼ã‚¿ãƒ¼/ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ï¼‰ã€èµ·æ¥­å®¶é©æ€§ã€ãã—ã¦æ©˜ç²ã€Œå¹¸ç¦ã®è³‡æœ¬è«–ã€ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸ6ã¤ã®è³‡æœ¬ï¼ˆé‡‘èãƒ»äººçš„ãƒ»ç¤¾ä¼šãƒ»èº«ä½“ãƒ»ç²¾ç¥ãƒ»çŸ¥è­˜ï¼‰ã«ç²¾é€šã—ã¦ã„ã¾ã™ã€‚

**è³‡æœ¬è«–ã®è€ƒãˆæ–¹**: 6ã¤ã®è³‡æœ¬ã¯ç›®æ¨™é”æˆã®ãŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹ã§ã‚ã‚Šã€2ã¤ä»¥ä¸Šã®è³‡æœ¬ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ç›®æ¨™é”æˆã®å¯èƒ½æ€§ãŒé«˜ã¾ã‚‹ã€‚

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§åˆ†æã—ã¦ãã ã•ã„ï¼š

1. **å¤šè§’çš„ãªåˆ†æ**: ä¸€ã¤ã®è§£é‡ˆã«å¯„ã›ãšã€è¤‡æ•°ã®å¯èƒ½æ€§ã‚’æç¤ºã™ã‚‹
2. **åˆ¥ã®è¦–ç‚¹**: ã€Œã“ã†è¦‹ãˆã‚‹ã‘ã©ã€å®Ÿã¯â€¦ã€ã¨ã„ã†è£èª­ã¿ã‚’å¿…ãšå«ã‚ã‚‹
3. **ç›²ç‚¹ã®æŒ‡æ‘˜**: è¦³å¯Ÿè€…ãŒè¦‹è½ã¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã€ãƒã‚¤ã‚¢ã‚¹ã®æŒ‡æ‘˜
4. **ãƒ“ã‚¸ãƒã‚¹ã§ã®æ´»ã‹ã—æ–¹**: ã“ã®äººã¨ã©ã†ä»˜ãåˆã„ã€ã©ã†æ´»ã‹ã™ã‹
5. **æ·±æ˜ã‚Šã®è³ªå•**: ã‚ˆã‚Šæ­£ç¢ºã«ç†è§£ã™ã‚‹ãŸã‚ã«ç¢ºèªã™ã¹ã3ã¤ã®è³ªå•

å¿–åº¦ã›ãšç‡ç›´ã«ã€‚ä¸€èˆ¬è«–ã§ã¯ãªãå…·ä½“çš„ã«ã€‚æ—¥æœ¬èªã§å›ç­”ã€‚`;

  const userMessage = input + context;

  document.getElementById('aiResult').innerHTML = '<div class="ai-loading">åˆ†æä¸­...</div>';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 4096,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMessage }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API Error');
    }

    const data = await response.json();
    const text = data.content[0].text;
    document.getElementById('aiResult').innerHTML = `<div class="ai-result">${formatAIResponse(text)}</div>`;
  } catch (e) {
    document.getElementById('aiResult').innerHTML = `<div class="card" style="color:var(--danger)">ã‚¨ãƒ©ãƒ¼: ${escHtml(e.message)}</div>`;
  }
}

async function runCoachingAI() {
  const apiKey = localStorage.getItem('anthropic_api_key');
  if (!apiKey) { alert('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }

  const model = document.getElementById('modelSelect').value;

  // Gather all saved data for the target person
  let targetName = lastTargetName || document.getElementById('aiInput').value.trim().split('\n')[0];
  const saved = getSaved();

  // Find entries for this person (or use all if no specific target)
  let personEntries = [];
  if (targetName) {
    const key = targetName.trim().toLowerCase();
    personEntries = saved.filter(e => e.name.trim().toLowerCase() === key);
  }
  if (!personEntries.length && lastScores) {
    // Use current session data
    personEntries = [{ name: targetName || 'å¯¾è±¡è€…', date: new Date().toISOString(), scoresCache: {} }];
    if (lastScores.bigfive) { personEntries[0].scoresCache.bigfive = {}; BF_ORDER.forEach(t => personEntries[0].scoresCache.bigfive[t] = lastScores.bigfive[t].avg); }
    if (lastScores.dark) { personEntries[0].scoresCache.dark = {}; DARK_ORDER.forEach(t => personEntries[0].scoresCache.dark[t] = lastScores.dark[t].avg); }
    if (lastScores.types) { personEntries[0].scoresCache.types = {}; TYPE_ORDER.forEach(t => personEntries[0].scoresCache.types[t] = lastScores.types[t].avg); }
    if (lastScores.entre) { personEntries[0].scoresCache.entre = {}; ENTRE_ORDER.forEach(t => personEntries[0].scoresCache.entre[t] = lastScores.entre[t].avg); }
    if (lastScores.capital) { personEntries[0].scoresCache.capital = {}; CAPITAL_ORDER.forEach(t => personEntries[0].scoresCache.capital[t] = lastScores.capital[t].avg); }
  }
  if (!personEntries.length) { alert('åˆ†æå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è¨ºæ–­ã‚’å®Ÿæ–½ã™ã‚‹ã‹ã€åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

  targetName = personEntries[0].name;

  // Build comprehensive data string
  let dataStr = `ã€${targetName} ã®å…¨è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ï¼ˆ${personEntries.length}å›åˆ†ï¼‰ã€‘\n`;
  personEntries.sort((a,b) => new Date(a.date) - new Date(b.date));
  personEntries.forEach((entry, idx) => {
    const d = new Date(entry.date);
    dataStr += `\n--- ${idx+1}å›ç›®ï¼ˆ${d.toLocaleDateString('ja-JP')}ï¼‰---\n`;
    const sc = entry.scoresCache;
    if (sc.bigfive) { dataStr += 'ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–: '; dataStr += BF_ORDER.map(t => `${BF_TRAITS[t].name}=${(sc.bigfive[t]||0).toFixed?sc.bigfive[t].toFixed(2):sc.bigfive[t]}`).join(', ') + '\n'; }
    if (sc.dark) { dataStr += 'ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰: '; dataStr += DARK_ORDER.map(t => `${DARK_TRAITS[t].name}=${(sc.dark[t]||0).toFixed?sc.dark[t].toFixed(2):sc.dark[t]}`).join(', ') + '\n'; }
    if (sc.types) { dataStr += '4ã‚¿ã‚¤ãƒ—: '; dataStr += TYPE_ORDER.map(t => `${TYPE_TRAITS[t].name}=${(sc.types[t]||0).toFixed?sc.types[t].toFixed(2):sc.types[t]}`).join(', ') + '\n'; }
    if (sc.entre) { dataStr += 'èµ·æ¥­å®¶é©æ€§: '; dataStr += ENTRE_ORDER.map(t => `${ENTRE_TRAITS[t].name}=${(sc.entre[t]||0).toFixed?sc.entre[t].toFixed(2):sc.entre[t]}`).join(', ') + '\n'; }
    if (sc.capital) { dataStr += 'è³‡æœ¬è«–: '; dataStr += CAPITAL_ORDER.map(t => `${CAPITAL_TRAITS[t].icon}${CAPITAL_TRAITS[t].name}=${(sc.capital[t]||0).toFixed?sc.capital[t].toFixed(2):sc.capital[t]}`).join(', ') + '\n'; }
  });

  // Add free text if any
  const freeText = document.getElementById('aiInput').value.trim();
  if (freeText) dataStr += `\nã€è¦³å¯Ÿè€…ã®è‡ªç”±è¨˜è¿°ã€‘\n${freeText}\n`;

  const coachingPrompt = COACHING_SYSTEM_PROMPT;

  document.getElementById('aiResult').innerHTML = '<div class="ai-loading">ç·åˆã‚³ãƒ¼ãƒãƒ³ã‚°åˆ†æä¸­...</div>';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 4096,
        system: coachingPrompt,
        messages: [{ role: 'user', content: dataStr }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API Error');
    }

    const data = await response.json();
    const text = data.content[0].text;
    document.getElementById('aiResult').innerHTML = `<div class="ai-result">${formatAIResponse(text)}</div>`;
  } catch (e) {
    document.getElementById('aiResult').innerHTML = `<div class="card" style="color:var(--danger)">ã‚¨ãƒ©ãƒ¼: ${escHtml(e.message)}</div>`;
  }
}

function formatAIResponse(text) {
  // Basic markdown-like formatting
  return text
    .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
    .replace(/\*(.+?)\*/g, '<i>$1</i>')
    .replace(/^### (.+)$/gm, '<div style="font-size:1.05em;font-weight:800;margin:14px 0 6px;color:var(--dark)">$1</div>')
    .replace(/^## (.+)$/gm, '<div style="font-size:1.1em;font-weight:800;margin:16px 0 8px;color:var(--accent)">$1</div>')
    .replace(/^# (.+)$/gm, '<div style="font-size:1.15em;font-weight:800;margin:18px 0 10px">$1</div>')
    .replace(/^- (.+)$/gm, '<div style="padding-left:12px">ãƒ»$1</div>')
    .replace(/^(\d+)\. (.+)$/gm, '<div style="padding-left:12px">$1. $2</div>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}

// ============================================================
// CHAT VIEW (per-person AI analysis + conversation)
// ============================================================
let chatPersonName = '';
let chatHistory = []; // {role:'user'|'assistant'|'system', content:string, time:string}

function getChatKey(name) { return 'po_chat_' + name.trim().toLowerCase(); }

function loadChatHistory(name) {
  try { return JSON.parse(localStorage.getItem(getChatKey(name)) || '[]'); } catch { return []; }
}
function saveChatHistory(name, history) {
  localStorage.setItem(getChatKey(name), JSON.stringify(history));
}

function buildPersonDataStr(name) {
  const saved = getSaved().filter(e => e.name.trim().toLowerCase() === name.trim().toLowerCase());
  if (!saved.length) return '';
  const sorted = [...saved].sort((a,b) => new Date(a.date) - new Date(b.date));
  let s = `ã€${name} ã®å…¨è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ï¼ˆ${sorted.length}å›åˆ†ï¼‰ã€‘\n`;
  sorted.forEach((entry, idx) => {
    const d = new Date(entry.date);
    s += `\n--- ${idx+1}å›ç›®ï¼ˆ${d.toLocaleDateString('ja-JP')}ï¼‰---\n`;
    const sc = entry.scoresCache;
    if (sc.bigfive) { s += 'ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–: ' + BF_ORDER.map(t => `${BF_TRAITS[t].name}=${Number(sc.bigfive[t]).toFixed(2)}`).join(', ') + '\n'; }
    if (sc.dark) { s += 'ãƒ€ãƒ¼ã‚¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ‰: ' + DARK_ORDER.map(t => `${DARK_TRAITS[t].name}=${Number(sc.dark[t]).toFixed(2)}`).join(', ') + '\n'; }
    if (sc.types) { s += '4ã‚¿ã‚¤ãƒ—: ' + TYPE_ORDER.map(t => `${TYPE_TRAITS[t].name}=${Number(sc.types[t]).toFixed(2)}`).join(', ') + '\n'; }
    if (sc.entre) { s += 'èµ·æ¥­å®¶é©æ€§: ' + ENTRE_ORDER.map(t => `${ENTRE_TRAITS[t].name}=${Number(sc.entre[t]).toFixed(2)}`).join(', ') + '\n'; }
    if (sc.capital) { s += 'è³‡æœ¬è«–: ' + CAPITAL_ORDER.map(t => `${CAPITAL_TRAITS[t].icon}${CAPITAL_TRAITS[t].name}=${Number(sc.capital[t]).toFixed(2)}`).join(', ') + '\n'; }
  });
  return s;
}

function openChat(name) {
  chatPersonName = name;
  chatHistory = loadChatHistory(name);

  const saved = getSaved().filter(e => e.name.trim().toLowerCase() === name.trim().toLowerCase());
  document.getElementById('chatHeader').innerHTML = `
    <div><div class="name">${escHtml(name)}</div><div class="meta">${saved.length}å›ã®è¨ºæ–­ãƒ‡ãƒ¼ã‚¿</div></div>`;

  renderChatMessages();

  // If no history, auto-run coaching analysis
  if (!chatHistory.length) {
    switchTab('chat');
    runInitialCoaching(name);
  } else {
    switchTab('chat');
  }
}

function renderChatMessages() {
  const c = document.getElementById('chatMessages');
  c.innerHTML = chatHistory.map(msg => {
    if (msg.role === 'system') {
      return `<div class="chat-msg system">${escHtml(msg.content)}<span class="time">${msg.time||''}</span></div>`;
    } else if (msg.role === 'user') {
      return `<div class="chat-msg user">${escHtml(msg.content)}<span class="time">${msg.time||''}</span></div>`;
    } else {
      return `<div class="chat-msg ai">${formatAIResponse(msg.content)}<span class="time">${msg.time||''}</span></div>`;
    }
  }).join('');
  // Scroll to bottom
  setTimeout(() => c.scrollTop = c.scrollHeight, 50);
}

function nowStr() {
  const d = new Date();
  return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function saveChatApiKey() {
  const key = document.getElementById('chatApiKeyInput').value.trim();
  if (!key) return;
  localStorage.setItem('anthropic_api_key', key);
  document.getElementById('apiKeyInput').value = key;
  document.getElementById('chatApiKeySection').style.display = 'none';
  if (chatPersonName) runInitialCoaching(chatPersonName);
}

async function runInitialCoaching(name) {
  const apiKey = localStorage.getItem('anthropic_api_key');
  if (!apiKey) {
    document.getElementById('chatApiKeySection').style.display = 'block';
    return;
  }

  const dataStr = buildPersonDataStr(name);
  if (!dataStr) {
    chatHistory.push({role:'system', content:'è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', time:nowStr()});
    saveChatHistory(name, chatHistory);
    renderChatMessages();
    return;
  }

  chatHistory.push({role:'system', content:'ç·åˆã‚³ãƒ¼ãƒãƒ³ã‚°åˆ†æã‚’å®Ÿè¡Œä¸­...', time:nowStr()});
  renderChatMessages();

  const model = document.getElementById('modelSelect').value;
  const coachingPrompt = COACHING_SYSTEM_PROMPT;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 4096,
        system: coachingPrompt,
        messages: [{ role: 'user', content: dataStr }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API Error');
    }

    const data = await response.json();
    const text = data.content[0].text;
    // Replace the loading message
    chatHistory.pop();
    chatHistory.push({role:'assistant', content: text, time: nowStr()});
    saveChatHistory(name, chatHistory);
    renderChatMessages();
  } catch (e) {
    chatHistory.pop();
    chatHistory.push({role:'system', content:'ã‚¨ãƒ©ãƒ¼: ' + e.message, time: nowStr()});
    saveChatHistory(name, chatHistory);
    renderChatMessages();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 240) + 'px';
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !chatPersonName) return;

  const apiKey = localStorage.getItem('anthropic_api_key');
  if (!apiKey) { alert('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }

  input.value = '';
  input.style.height = '';
  chatHistory.push({role:'user', content: text, time: nowStr()});
  chatHistory.push({role:'system', content:'è€ƒãˆä¸­...', time:''});
  saveChatHistory(chatPersonName, chatHistory);
  renderChatMessages();

  const dataStr = buildPersonDataStr(chatPersonName);
  const model = document.getElementById('modelSelect').value;

  const systemPrompt = `ã‚ãªãŸã¯æ€§æ ¼åˆ†æãƒ»ã‚³ãƒ¼ãƒãƒ³ã‚°ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ã€Œ${chatPersonName}ã€ã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

${dataStr}

**åˆ†æã®å§¿å‹¢**:
- å¿–åº¦ã›ãšç‡ç›´ã«
- å¤šè§’çš„ãªè¦–ç‚¹ï¼ˆã€Œã“ã†è¦‹ãˆã‚‹ã‘ã©å®Ÿã¯â€¦ã€ã‚’å«ã‚ã‚‹ï¼‰
- è³‡æœ¬è«–ã®è€ƒãˆæ–¹: 2ã¤ä»¥ä¸Šã®è³‡æœ¬ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ç›®æ¨™é”æˆ
- æƒœã—ã„ã¨ã“ã‚ã€å°‘ã—ä¼¸ã°ã›ã°å¤‰ã‚ã‚‹ã¨ã“ã‚ã«æ³¨ç›®
- ADHD/HSP/é¬±/èºé¬±/ASDç­‰ã®å‚¾å‘ãŒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹å ´åˆã¯æŒ‡æ‘˜ã—ã€ã€Œæ‰±ãˆãŸã‚‰å¼·ã„ã€æ´»ç”¨æ³•ã‚’ã‚»ãƒƒãƒˆã§æç¤º
- æ—¥æœ¬èªã§å›ç­”`;

  // Build messages from chat history (exclude system messages and the loading one)
  const messages = chatHistory
    .filter(m => m.role === 'user' || m.role === 'assistant')
    .map(m => ({role: m.role, content: m.content}));

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 4096,
        system: systemPrompt,
        messages: messages
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API Error');
    }

    const data = await response.json();
    const reply = data.content[0].text;
    // Replace loading message
    chatHistory.pop();
    chatHistory.push({role:'assistant', content: reply, time: nowStr()});
    saveChatHistory(chatPersonName, chatHistory);
    renderChatMessages();
  } catch (e) {
    chatHistory.pop();
    chatHistory.push({role:'system', content:'ã‚¨ãƒ©ãƒ¼: ' + e.message, time: nowStr()});
    saveChatHistory(chatPersonName, chatHistory);
    renderChatMessages();
  }
}

// ============================================================
// RESET
// ============================================================
function resetAll() {
  answers = {};
  currentPage = 0;
  lastScores = null;
  lastTargetName = '';
  document.getElementById('targetName').value = '';
  document.getElementById('setupPhase').style.display = '';
  document.getElementById('questionPhase').style.display = 'none';
  document.getElementById('resultPhase').style.display = 'none';
  renderModuleGrid();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ============================================================
// INIT
// ============================================================
renderModuleGrid();
updateBadge();
// Restore API key
const savedKey = localStorage.getItem('anthropic_api_key');
if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
// Restore GAS URL & Drive UI
const savedGasUrl = getGasUrl();
if (savedGasUrl) document.getElementById('gasUrlInput').value = savedGasUrl;
updateDriveUI();
</script>
</body>
</html>
